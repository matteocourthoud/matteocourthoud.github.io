<!DOCTYPE html><html lang="en-us" >

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.1.0 for Hugo" />
  

  

  
  
  
  
  
    
    
    
  
  

  

  
  
  
    
  
  <meta name="description" content="An introduction to quantile regression.
In A/B tests, a.k.a. randomized controlled trials, we usually estimate the average treatment effect (ATE): effect of a treatment (a drug, ad, product, &hellip;) on an outcome of interest (a disease, firm revenue, customer satisfaction, &hellip;), where the &ldquo;average&rdquo; is taken over the test subjects (patients, users, customers, &hellip;)." />

  
  <link rel="alternate" hreflang="en-us" href="https://matteocourthoud.github.io/post/quantile_regression/" />

  







  




  
  
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    <meta name="theme-color" content="#003f5c" />
  

  
  
    
    <script src="/js/mathjax-config.js"></script>
  

  
  
  
  
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin="anonymous">

    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css" integrity="sha512-1xoFisiGdy9nvho8EgXuXvnpR5GAMSjFwp40gSRE3NwdUdIMIKuPa7bqoUhLD0O/5tPNhteAsE5XyyMi5reQVA==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Source+Sans+Pro:wght@200;300;400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Source+Sans+Pro:wght@200;300;400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.4f7182ca394d705ee32d9d7750e9aa1d.css" />

  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-144780600-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'UA-144780600-1', { 'anonymize_ip': true });
  gtag('set', {'cookie_flags': 'SameSite=None;Secure'});

  
  document.addEventListener('click', onClickCallback, false);
</script>


  

  

  




  
  
  

  

  
    <link rel="manifest" href="/index.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu03e9b3967b83fd39296ec9da5ff1ea05_201175_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu03e9b3967b83fd39296ec9da5ff1ea05_201175_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://matteocourthoud.github.io/post/quantile_regression/" />

  
  
  
  
  
  
  
  
    
  
  
  <meta property="twitter:card" content="summary_large_image" />
  
  <meta property="og:site_name" content="Matteo Courthoud" />
  <meta property="og:url" content="https://matteocourthoud.github.io/post/quantile_regression/" />
  <meta property="og:title" content="Mean vs Median Causal Effect | Matteo Courthoud" />
  <meta property="og:description" content="An introduction to quantile regression.
In A/B tests, a.k.a. randomized controlled trials, we usually estimate the average treatment effect (ATE): effect of a treatment (a drug, ad, product, &hellip;) on an outcome of interest (a disease, firm revenue, customer satisfaction, &hellip;), where the &ldquo;average&rdquo; is taken over the test subjects (patients, users, customers, &hellip;)." /><meta property="og:image" content="https://matteocourthoud.github.io/post/quantile_regression/featured.png" />
    <meta property="twitter:image" content="https://matteocourthoud.github.io/post/quantile_regression/featured.png" /><meta property="og:locale" content="en-us" />
  
    
      <meta
        property="article:published_time"
        content="2023-07-10T00:00:00&#43;00:00"
      />
    
    <meta property="article:modified_time" content="2023-07-10T00:00:00&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://matteocourthoud.github.io/post/quantile_regression/"
  },
  "headline": "Mean vs Median Causal Effect",
  
  "image": [
    "https://matteocourthoud.github.io/post/quantile_regression/featured.png"
  ],
  
  "datePublished": "2023-07-10T00:00:00Z",
  "dateModified": "2023-07-10T00:00:00Z",
  
  "publisher": {
    "@type": "Organization",
    "name": "Matteo Courthoud",
    "logo": {
      "@type": "ImageObject",
      "url": "https://matteocourthoud.github.io/media/icon_hu03e9b3967b83fd39296ec9da5ff1ea05_201175_192x192_fill_lanczos_center_3.png"
    }
  },
  "description": "An introduction to quantile regression.\nIn A/B tests, a.k.a. randomized controlled trials, we usually estimate the average treatment effect (ATE): effect of a treatment (a drug, ad, product, \u0026hellip;) on an outcome of interest (a disease, firm revenue, customer satisfaction, \u0026hellip;), where the \u0026ldquo;average\u0026rdquo; is taken over the test subjects (patients, users, customers, \u0026hellip;)."
}
</script>

  

  

  
  
  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.js" integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.css" integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin="anonymous">
  
  <script>
  window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#003f5c",
          "text": "rgb(255, 255, 255)"
        },
        "button": {
          "background": "rgb(255, 255, 255)",
          "text": "#003f5c"
        }
      },
      "theme": "classic",
      "content": {
        "message": "This website uses cookies to ensure you get the best experience on our website.",
        "dismiss": "Got it!",
        "link": "Learn more",
        "href": "/privacy/"
      }
    })});
  </script>


  





  <title>Mean vs Median Causal Effect | Matteo Courthoud</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="5517fe2a3e5b8f4dd887476d9f7fdafd" >

  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.66d3e0fff6d32c4ece05adee927fbd96.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="Close"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="Search...">
        
      </div>

      
      

      

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    












<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container-xl">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">Matteo Courthoud</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">Matteo Courthoud</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-end" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#projects"><span>Research</span></a>
        </li>

        
        

        
        <li class="nav-item dropdown">
          <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>Courses</span><span class="caret"></span>
          </a>
          <div class="dropdown-menu">
            
              <a class="dropdown-item" href="/course/ml-econ/"><span>Machine Learning for Economics</span></a>
            
              <a class="dropdown-item" href="/course/data-science/"><span>Data Science with Python</span></a>
            
              <a class="dropdown-item" href="/course/empirical-io/"><span>PhD Industrial Organization</span></a>
            
              <a class="dropdown-item" href="/course/metrics/"><span>PhD Econometrics</span></a>
            
              <a class="dropdown-item" href="https://pp4rs.github.io/"><span>Programming Practices for Research</span></a>
            
          </div>
        </li>

        
        

        

        
        
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/cv"><span>CV</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

      
      
        
      

      
      

      
      

      
      

    </ul>

  </div>
</nav>


  </div>

  <div class="page-body">
    <div class="container-fluid docs">
  <div class="row">

    <div class="col-xl-2 col-lg-2 d-none d-xl-block d-lg-block empty">
    </div>

    <div class="col-2 col-xl-2 col-lg-2 d-none d-lg-block docs-toc">
      <ul class="nav toc-top">
        <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
      </ul>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#loyalty-cards-and-spending">Loyalty Cards and Spending</a></li>
    <li><a href="#mean-vs-median">Mean vs Median</a></li>
    <li><a href="#quantile-regression">Quantile Regression</a></li>
    <li><a href="#estimation">Estimation</a></li>
    <li><a href="#inference">Inference</a></li>
    <li><a href="#interpretation">Interpretation</a></li>
    <li><a href="#conclusion">Conclusion</a>
      <ul>
        <li><a href="#references">References</a></li>
        <li><a href="#related-articles">Related Articles</a></li>
        <li><a href="#code">Code</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <main class="col-xl-8 col-lg-8 docs-content" role="main">
        <article class="article">
        




















  


<div class="article-container pt-3">
  <h1>Mean vs Median Causal Effect</h1>

  

  


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    Jul 10, 2023
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    13 min read
  </span>
  

  
  
  
  
  
  

  
  

</div>

  





</div>


<div class="article-header article-container featured-image-wrapper mt-4 mb-4" style="max-width: 1540px; max-height: 874px;">
  <div style="position: relative">
    <img src="/post/quantile_regression/featured.png" alt="" class="featured-image">
    
  </div>
</div>


        <div class="article-container">
          <div class="article-style" align="justify">
            <p><em>An introduction to quantile regression.</em></p>
<p>In A/B tests, a.k.a. <a href="https://en.wikipedia.org/wiki/Randomized_controlled_trial" target="_blank" rel="noopener">randomized controlled trials</a>, we usually estimate the <strong>average treatment effect (ATE)</strong>: effect of a treatment (a drug, ad, product, &hellip;) on an outcome of interest (a disease, firm revenue, customer satisfaction, &hellip;), where the &ldquo;average&rdquo; is taken over the test subjects (patients, users, customers, &hellip;). The ATE is a very useful quantity since it tells us the effect that we can expect if we were to treat a new subject with the same treatment.</p>
<p>However, sometimes we might be interested in quantities different from the average, such as the <a href="https://en.wikipedia.org/wiki/Median" target="_blank" rel="noopener"><strong>median</strong></a>. The median is an alternative measure of <em>central tendency</em> that is more robust to outliers and is often more informative with skewed distributions. More generally, we might want to estimate the effect for different <a href="https://en.wikipedia.org/wiki/Quantile" target="_blank" rel="noopener">quantiles</a> of the outcome distribution. A <strong>common use-case</strong> is studying the impact of a UI change on the loading time of a website: a slightly heavier website might translate in an imperceptible change for most users, but a big change for a few users with very slow connections. Another common use-case is studying the impact of a product change on a product that is bought by few people: do existing customers buy it more or are we attracting new customers?</p>
<p>These questions are hard to answer with linear regression that estimates the <em>average treatment effect</em>. A more suitable tool is <strong>quantile regression</strong> that can instead estimate the <em>median treatment effect</em>. In this article we are going to cover a brief introduction to quantile regression and the estimation of quantile treatment effects.</p>
<h2 id="loyalty-cards-and-spending">Loyalty Cards and Spending</h2>
<p>Suppose we were an <strong>online store</strong> and we wanted to increase sales. We decide to offer our customers a <strong>loyalty card</strong> that grants them discounts as they increase their spend in the store. We would like to assess if the loyalty card is effective in increasing sales so we run an <strong>A/B test</strong>: we offer the loyalty card only to a subset of our customers, at random.</p>
<p>I import the data generating process <code>dgp_loyalty()</code> from <a href="https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/src/dgp.py" target="_blank" rel="noopener"><code>src.dgp</code></a>. I also import some plotting functions and libraries from <a href="https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/src/utils.py" target="_blank" rel="noopener"><code>src.utils</code></a>.  To include not only code but also data and tables, I use <a href="https://deepnote.com" target="_blank" rel="noopener">Deepnote</a>, a Jupyter-like web-based collaborative notebook environment.</p>
<pre><code class="language-python">%matplotlib inline
%config InlineBackend.figure_format = 'retina'

from src.utils import *
from src.dgp import dgp_loyalty
</code></pre>
<p>Now, let&rsquo;s have a look at the data. We have information on $10.000$ customers, for whom we observe their <code>spend</code> and whether they were offered the <code>loyalty</code> card. We also observe some demographics, like <code>age</code> and <code>gender</code>.</p>
<pre><code class="language-python">df = dgp_loyalty().generate_data()
df.head()
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loyalty</th>
      <th>spend</th>
      <th>age</th>
      <th>gender</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>0.0</td>
      <td>30</td>
      <td>Male</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>0.0</td>
      <td>26</td>
      <td>Male</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>0.0</td>
      <td>27</td>
      <td>Male</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>0.0</td>
      <td>29</td>
      <td>Male</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>0.0</td>
      <td>23</td>
      <td>Female</td>
    </tr>
  </tbody>
</table>
</div>
<p>Interestingly, we notice that the outcome of interest, <code>spend</code>, seems to have a lot of zeros. Let&rsquo;s dig deeper.</p>
<h2 id="mean-vs-median">Mean vs Median</h2>
<p>Before analyzing our experiment, let&rsquo;s have a look at our outcome variable, <code>spend</code>. We first inspect it using centrality measures. We have two main options: the <strong>mean</strong> and the <strong>median</strong>.</p>
<p>First of all, what are they? The mean captures the average value, while the median captures the value in the middle of the distribution. In general, the mean is mathematically more tractable and easier to interpret, while the median is more robust to outliers. You can find plenty of articles online comparing the two measures and suggesting which one is more appropriate and when. Let&rsquo;s have a look at the mean and median <code>spend</code>.</p>
<pre><code class="language-python">np.mean(df['spend'])
</code></pre>
<pre><code>28.136224
</code></pre>
<pre><code class="language-python">np.median(df['spend'])
</code></pre>
<pre><code>0.0
</code></pre>
<p>How do we interpret these two numbers? People spend on average 28\$ on our store. However, more than 50% of people don&rsquo;t spend anything. As we can see, both measures are very informative and, to a certain extent, complementary. We can better understand the distribution of <code>spend</code> by plotting its histogram.</p>
<pre><code class="language-python">sns.histplot(data=df, x=&quot;spend&quot;).set(ylabel='', title='Spending Distribution');
</code></pre>
<p><img src="img/quantile_regression_14_0.png" alt="png"></p>
<p>As previewed by the values of the mean and the median, the distribution of <code>spend</code> is very skewed, with more than 5000 customers (out of 10000) not spending anything.</p>
<p>One natural question then is: are we interested in the effect of the <code>loyalty</code> card on average <code>spend</code> or on median <code>spend</code>? The first would tell us if customers spend more on average, while the second would tell us if the average customer spends more.</p>
<p>Linear regression can tell us the effect of the <code>loyalty</code> card on average <code>spend</code>. However, what can we do if we were interested in the effect of the <code>loyalty</code> card on median <code>spend</code> (or other quantiles)? The answer is <strong>quantile regression</strong>.</p>
<h2 id="quantile-regression">Quantile Regression</h2>
<p>With <strong>linear regression</strong>, we try to estimate the <em>conditional expectation function</em> of an outcome variable $Y$ (<code>spend</code> in our example) with respect to one or more explanatory variables $X$ (<code>loyalty</code> in our example).</p>
<p>$$
\mathbb E \big[ Y \big| X \big]
$$</p>
<p>In other words, we want to find a function $f$ such that $f(X) = \mathbb E[Y|X]$. We do so, by solving the following minimization problem:</p>
<p>$$
\hat f(X) = \arg \min_{f} \mathbb E \big[ Y - f(X) \big]^2
$$</p>
<p>It can be shown that the function $f$ that solves this minimization is indeed the conditional expectation of $Y$, with respect to $X$.</p>
<p>Since $f(X)$ can be infinite dimensional, we usually estimate a parametric form of $f(X)$. The most common one is the linear form $f(X) = \beta X$, where $\beta$ is estimated by solving the corresponding minimization problem:</p>
<p>$$
\hat \beta = \arg \min_{\beta} \mathbb E \big[ Y - \beta X \big]^2
$$</p>
<p>The linear form is not just convenient, but it can be interpreted as the best local approximation of $f(X)$, referring to Taylor&rsquo;s expansion.</p>
<p>With <strong>quantile regression</strong>, we do the <strong>same</strong>. The only difference is that, instead of estimating the conditional expectation of $Y$ with respect to $X$, we want to estimate the $q$-<a href="https://en.wikipedia.org/wiki/Quantile" target="_blank" rel="noopener">quantile</a> of $Y$ with respect to $X$.</p>
<p>$$
\mathbb Q_q \big[ Y \big| X \big]
$$</p>
<p>First of all, what is a <strong>quantile</strong>? The <a href="https://en.wikipedia.org/wiki/Quantile" target="_blank" rel="noopener">Wikipedia definition</a> says</p>
<blockquote>
<p>&ldquo;In statistics and probability, quantiles are cut points dividing the range of a probability distribution into continuous intervals with equal probabilities, or dividing the observations in a sample in the same way. Common quantiles have special names, such as quartiles (four groups), deciles (ten groups), and percentiles (100 groups).&rdquo;</p>
</blockquote>
<p>For example, the 0.1-quantile represents the value that sits on the right of 10% of the mass of the distribution. The <strong>median</strong> is the 0.5-quantile (or, equivalently, the $50^{th}$ percentile or the $5^{th}$ decile) and corresponds with the value in the center of the distribution. Let&rsquo;s see a simple example with a <a href="https://en.wikipedia.org/wiki/Log-normal_distribution" target="_blank" rel="noopener">log-normal distribution</a>. I plot the three quartiles that divide the data in four equally sized bins.</p>
<pre><code class="language-python">data = np.random.lognormal(0, 1, 1_000_000);
sns.histplot(data).set(title='Lognormal Distribution', xlim=(0,10))
plt.axvline(x=np.percentile(data, 25), c='C8', label='25th percentile')
plt.axvline(x=np.median(data), c='C1', label='Median (50th pct)')
plt.axvline(x=np.percentile(data, 75), c='C3', label='75th percentile')
plt.legend();
</code></pre>
<p><img src="img/quantile_regression_18_0.png" alt="png"></p>
<p>As we can see, the three quartiles divide the data into four bins, of equal size.</p>
<p>So, what is the <strong>objective</strong> of quantile regression? The objective is to find a function $f$ such that $f(X) = F^{-1}(y_q)$, where $F$ is the <a href="https://en.wikipedia.org/wiki/Cumulative_distribution_function" target="_blank" rel="noopener">cumulative distribution function</a> of $Y$ and $y_q$ is the $q$-quantile of the distribution of $Y$.</p>
<p>How do we do this? It can be shown with a little linear algebra that we can obtain the conditional quantile as the solution of the following minimization problem:</p>
<p>$$
\hat f(X) = \arg \min_{f} \mathbb E \big[ \rho_q (Y - f(X)) \big] = \arg \min_{f} \ (1-q) \int_{-\infty}^{f(x)} (y - f(x)) \text{d} F(y) + q \int_{f(x)}^{\infty} (y - f(x)) \text{d} F(y)
$$</p>
<p>Where $\rho_q$ is an auxiliary weighting function with the following shape.</p>
<img src="fig/rho.png" width="400px"/>
<p>What is the <strong>intuition</strong> behind the objective function?</p>
<p>The idea is that we can interpret the equation as follows</p>
<p>$$
\mathbb E \big[ \rho_q (Y - f(X)) \big] = (1-q) \underset{\color{red}{\text{mass of distribution below }f(x)}}{\int_{-\infty}^{f(x)} (y - f(x)) \text{d} F(y)} + q \underset{\color{red}{\text{mass of distribution above }f(x)}}{\int_{f(x)}^{\infty} (y - f(x)) \text{d} F(y)} \overset{\color{blue}{\text{if } f(x) = y_q}}{=} - (1-q) q + q (1-q) = 0
$$</p>
<p>So that, when $f(X)$ corresponds with the quantile $y_q$, the value of the objective function is zero.</p>
<p>Exactly as before, we can estimate a <strong>parametric form</strong> of $f$ and, exactly as before, we can interpret it as a best local approximation (not trivially though, see <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1468-0262.2006.00671.x" target="_blank" rel="noopener">Angrist, Chernozhukov, and Fernández-Val (2006)</a>).</p>
<p>$$
\hat \beta_q = \arg \min_{\beta} \mathbb E \big[ \rho_q (Y - \beta X ) \big]
$$</p>
<p>We wrote $\hat \beta_q$ to indicate that this is the coefficient for the best linear approximation of the conditional $q$-quantile function.</p>
<p>How do we <strong>estimate</strong> a quantile regression?</p>
<h2 id="estimation">Estimation</h2>
<p>The <a href="https://www.statsmodels.org/stable/index.html" target="_blank" rel="noopener">statsmodels</a> package allows us to estimate quantile regression with the the <a href="https://www.statsmodels.org/dev/generated/statsmodels.regression.quantile_regression.QuantReg.html" target="_blank" rel="noopener"><code>quantreg()</code></a> function. We just need to specify the quantile $q$ when we fit the model. Let&rsquo;s use $q=0.5$, which corresponds with the median.</p>
<pre><code class="language-python">smf.quantreg(&quot;spend ~ loyalty&quot;, data=df).fit(q=0.5).summary().tables[1]
</code></pre>
<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td> 8.668e-07</td> <td>    0.153</td> <td> 5.66e-06</td> <td> 1.000</td> <td>   -0.300</td> <td>    0.300</td>
</tr>
<tr>
  <th>loyalty</th>   <td>    3.4000</td> <td>    0.217</td> <td>   15.649</td> <td> 0.000</td> <td>    2.974</td> <td>    3.826</td>
</tr>
</table>
<p>Quantile regression estimates a positive coefficient for <code>loyalty</code>. How does this estimate compare with linear regression?</p>
<pre><code class="language-python">smf.ols(&quot;spend ~ loyalty&quot;, data=df).fit().summary().tables[1]
</code></pre>
<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td>   25.6583</td> <td>    0.564</td> <td>   45.465</td> <td> 0.000</td> <td>   24.552</td> <td>   26.765</td>
</tr>
<tr>
  <th>loyalty</th>   <td>    4.9887</td> <td>    0.801</td> <td>    6.230</td> <td> 0.000</td> <td>    3.419</td> <td>    6.558</td>
</tr>
</table>
<p>The estimated coefficient with linear regression is higher. What does it mean? We will spend more time on the <em>interpretation</em> of quantile regression coefficients later.</p>
<p>Can we condition the analysis on other variables? We suspect that <code>spend</code> is also affected by other variables and we want to increase the precision of our estimate by also conditioning the analysis on <code>age</code> and <code>gender</code>. We can just add the variables to the <code>quantreg()</code> model.</p>
<pre><code class="language-python">smf.quantreg(&quot;spend ~ loyalty + age + gender&quot;, data=df).fit(q=0.5).summary().tables[1]
</code></pre>
<table class="simpletable">
<tr>
         <td></td>           <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th>      <td>  -50.5353</td> <td>    1.053</td> <td>  -47.977</td> <td> 0.000</td> <td>  -52.600</td> <td>  -48.471</td>
</tr>
<tr>
  <th>gender[T.Male]</th> <td>  -20.2963</td> <td>    0.557</td> <td>  -36.410</td> <td> 0.000</td> <td>  -21.389</td> <td>  -19.204</td>
</tr>
<tr>
  <th>loyalty</th>        <td>    4.5747</td> <td>    0.546</td> <td>    8.374</td> <td> 0.000</td> <td>    3.504</td> <td>    5.646</td>
</tr>
<tr>
  <th>age</th>            <td>    2.3663</td> <td>    0.026</td> <td>   92.293</td> <td> 0.000</td> <td>    2.316</td> <td>    2.417</td>
</tr>
</table>
<p>The coefficient of <code>loyalty</code> increases when we condition the analysis on <code>age</code> and <code>gender</code>. This is true also for linear regresssion.</p>
<pre><code class="language-python">smf.ols(&quot;spend ~ loyalty + age + gender&quot;, data=df).fit().summary().tables[1]
</code></pre>
<table class="simpletable">
<tr>
         <td></td>           <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th>      <td>  -57.4466</td> <td>    0.911</td> <td>  -63.028</td> <td> 0.000</td> <td>  -59.233</td> <td>  -55.660</td>
</tr>
<tr>
  <th>gender[T.Male]</th> <td>  -26.3170</td> <td>    0.482</td> <td>  -54.559</td> <td> 0.000</td> <td>  -27.262</td> <td>  -25.371</td>
</tr>
<tr>
  <th>loyalty</th>        <td>    3.9101</td> <td>    0.473</td> <td>    8.272</td> <td> 0.000</td> <td>    2.983</td> <td>    4.837</td>
</tr>
<tr>
  <th>age</th>            <td>    2.7688</td> <td>    0.022</td> <td>  124.800</td> <td> 0.000</td> <td>    2.725</td> <td>    2.812</td>
</tr>
</table>
<p>There are a couple of things that we haven&rsquo;t mentioned yet. The first one is <strong>inference</strong>. How do we compute confidence intervals and p-values for our estimates in quantile regression?</p>
<h2 id="inference">Inference</h2>
<p>The asymptotic variance of the estimate $a$ of the quantile $q$ of a distribution $F$ is given by</p>
<p>$$
AVar(y) = q(1-q) f^{-2}(y)
$$</p>
<p>where $f$ is the <a href="https://en.wikipedia.org/wiki/Probability_density_function" target="_blank" rel="noopener">density function</a> of $F$. This expression can be decomposed into <strong>two components</strong>: $q(1-q)$ and $f^{-2}(y)$.</p>
<p>The first component, $q(1-q)$, basically tells us that the variance of a quantile is higher the more the quantile is closer to the center of the distribution. Why is that so? First, we need to think about when the quantile of a point changes in response to a change in the value of a second point. The quantile changes when the second point swaps from left to right (or viceversa) of the first point. This is intuitively very easy if the first point lies in the middle of the distribution, but very hard if it lies at the extreme.</p>
<p>The second component, $f^{-2}(a)$, instead tells us that this side swapping is more likely if the first point is surrounded by a lot of points.</p>
<p>Importantly, estimating the variance of a quantile requires an estimate of the whole distribution of $Y$. This is done via approximation and it can be computationally very intensive. However, alternative procedures like the bootstrap or the <a href="https://towardsdatascience.com/6ca4a1d45148" target="_blank" rel="noopener">bayesian bootstrap</a> are always available.</p>
<p>The second thing that we haven&rsquo;t talked about yet is the <strong>interpretation</strong> of the estimated coefficients. We got a lower coefficient of <code>loyalty</code> on <code>spend</code> with median regression. What does it mean?</p>
<h2 id="interpretation">Interpretation</h2>
<p>The <strong>interpretation</strong> of linear regression coefficients is straightforward: each coefficient is the derivative of the conditional expectation function $\mathbb E[Y|X]$ with respect to one dimension of $X$. In our case, we can interpret the regression coefficient of <code>loyalty</code> as the average <code>spend</code> increase from being offered a loyalty card. Crucially, here &ldquo;average&rdquo; means that this holds true for <em>each customer</em>, on average.</p>
<p>However, the interpretation of quantile regression coefficients is <strong>tricky</strong>. Before, we were tempted to say that the <code>loyalty</code> card increases the spend of the median customer by 3.4\$. But <strong>what does it mean</strong>? Is it the same median customer that spends more or do we have a different median customer? This might seem like a philosophical question but it has important implications on reporting of quantile regression results. In the first case, we are making a statement that, as for the interpretation of linear regression coefficients, applies to a <em>single individual</em>. In the second case, we are making a statement about the <em>distribution</em>.</p>
<p><a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1468-0262.2005.00570.x" target="_blank" rel="noopener">Chernozhukov and Hansen (2005)</a> show that a strong but helpful assumption is <strong>rank invariance</strong>: assuming that the treatment <strong>does not shift</strong> the relative composition of the distribution. In other words, if we rank people by <code>spend</code> before the experiment, we assume that this ranking is not affected by the introduction of the <code>loyalty</code> card. If I was spending less than you before, I might spend more afterwards, but still less than you (for any two people).</p>
<p>Under this assumption, we can interpret the quantile coefficients as <strong>marginal effects for single individuals</strong> sitting at different points of the outcome distribution, as in the first interpretation provided above. Moreover, we can report the treatment effect for many quantiles and interpret each one of them as a local effect for a different individual. Let&rsquo;s plot the distribution of treatment effects, for different quantiles of <code>spend</code>.</p>
<pre><code class="language-python">def plot_quantile_TE(df, formula, q, varname):
    df_results = pd.DataFrame()
    for q in np.arange(q, 1-q, q):
        qreg = smf.quantreg(formula, data=df).fit(q=q)
        temp = pd.DataFrame({'q': [q],
                             'coeff': [qreg.params[varname]], 
                             'std': [qreg.bse[varname]],
                             'ci_lower': [qreg.conf_int()[0][varname]],
                             'ci_upper': [qreg.conf_int()[1][varname]]})
        df_results = pd.concat([df_results, temp]).reset_index(drop=True)
    
    # Plot
    fig, ax = plt.subplots()
    sns.lineplot(data=df_results, x='q', y='coeff')
    ax.fill_between(data=df_results, x='q', y1='ci_lower', y2='ci_upper', alpha=0.1);
    plt.axhline(y=0, c=&quot;k&quot;, lw=2, zorder=1)
    ols_coeff = smf.ols(formula, data=df).fit().params[varname]
    plt.axhline(y=ols_coeff, ls=&quot;--&quot;, c=&quot;C1&quot;, label=&quot;OLS coefficient&quot;, zorder=1)
    plt.legend()
    plt.title(&quot;Estimated coefficient, by quantile&quot;)
</code></pre>
<pre><code class="language-python">plot_quantile_TE(df, formula=&quot;spend ~ loyalty&quot;, varname='loyalty', q=0.05)
</code></pre>
<p><img src="img/quantile_regression_37_0.png" alt="png"></p>
<p>This plot is <strong>extremely insightful</strong>: for almost half of the customers, the <code>loyalty</code> card has no effect. On the other hand, customers that were already spending something end up spending even more (around 10/12\$ more). This is a very powerful insight that we would have missed with linear regression that estimated an average effect of 5\$.</p>
<p>We can repeat the same exercise, conditioning the analysis on <code>gender</code> and <code>age</code>.</p>
<pre><code class="language-python">plot_quantile_TE(df, formula=&quot;spend ~ loyalty + age + gender&quot;, varname='loyalty', q=0.05)
</code></pre>
<p><img src="img/quantile_regression_39_0.png" alt="png"></p>
<p>Conditioning on other covariates removes a lot of the heterogeneity in treatment effects. The <code>loyalty</code> card increases spending for most people, it&rsquo;s demographic characteristics that are responsible for no spending to begin with.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this article, we have explored a different <strong>causal estimand</strong>: median treatment effects. How does it compare with the average treatment effect that we usually estimate? The pros and cons are closely related to the pros and cons of the median with respect to the mean as a measure of <em>central tendency</em>. Median treatment effects are more informative on what is the effect on the average subject and are more robust to outliers. However, they are much more computationally intensive and they require strong assumptions for identification, such as rank invariance.</p>
<h3 id="references">References</h3>
<p>[1] R. Koenker, <a href="https://www.cambridge.org/core/books/quantile-regression/C18AE7BCF3EC43C16937390D44A328B1" target="_blank" rel="noopener">Quantile Regression</a> (1996), Cambridge University Press.</p>
<p>[1] R. Koenker, K. Hallock, <a href="https://www.aeaweb.org/articles?id=10.1257/jep.15.4.143" target="_blank" rel="noopener">Quantile Regression</a>, (2001), <em>Journal of Economic Perspectives</em>.</p>
<p>[2] V. Chernozhukov, C. Hansen, <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1468-0262.2005.00570.x" target="_blank" rel="noopener">An IV Model of Quantile Treatment Effects</a> (2005), <em>Econometrica</em>.</p>
<p>[3] J. Angrist, V. Chernozhukov, I. Fernández-Val, <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1468-0262.2006.00671.x" target="_blank" rel="noopener">Quantile Regression under Misspecification, with an Application to the U.S. Wage Structure</a> (2006), <em>Econometrica</em>.</p>
<h3 id="related-articles">Related Articles</h3>
<ul>
<li><a href="https://towardsdatascience.com/b63dc69e3d8c" target="_blank" rel="noopener">DAGs and Control Variables</a></li>
<li><a href="https://towardsdatascience.com/6ca4a1d45148" target="_blank" rel="noopener">The Bayesian Bootstrap</a></li>
<li><a href="https://towardsdatascience.com/a928f67413e4" target="_blank" rel="noopener">Goodbye Scatterplot, Welcome Binned Scatterplot</a></li>
</ul>
<h3 id="code">Code</h3>
<p>You can find the original Jupyter Notebook here:</p>
<p><a href="https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/quantile_reg.ipynb" target="_blank" rel="noopener">https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/quantile_reg.ipynb</a></p>

          </div>
          


















  
  



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="https://matteocourthoud.github.io/"><img class="avatar mr-3 avatar-circle" src="/author/avatar_hu365eedc833ccd5578a90de7c849ec45e_385094_270x270_fill_q75_lanczos_center.jpg" alt=""></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://matteocourthoud.github.io/"></a></h5>
      
      <p class="card-text">I hold a PhD in economics from the University of Zurich. Now I work at the intersection of economics, data science and statistics. I regularly write about causal inference on <a href="https://medium.com/@matteo.courthoud" target="_blank" rel="noopener">Medium</a>.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://medium.com/@matteo.courthoud" target="_blank" rel="noopener">
        <i class="fab fa-medium"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/matteo-courthoud-7335198a/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/MatteoCourthoud/" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/matteocourthoud" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://open.spotify.com/user/1180947523" target="_blank" rel="noopener">
        <i class="fab fa-spotify"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>
















  
  




        </div>
        </article>
    </main>
  </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  

  
  <p class="powered-by">
    
      <a href="/privacy/">Privacy Policy</a>
    
    
       &middot; 
      <a href="/terms/">Terms</a>
    
  </p>
  

  

  
  







</footer>

    </div>
    
  </div>

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js" integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin="anonymous"></script>

      
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.8.4/mermaid.min.js" integrity="sha512-as1BF4+iHZ3BVO6LLDQ7zrbvTXM+c/1iZ1qII/c3c4L8Rn5tHLpFUtpaEtBNS92f+xGsCzsD7b62XP3XYap6oA==" crossorigin="anonymous" title="mermaid"></script>
      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js" integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/python.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/julia.min.js"></script>
        
      

    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js" integrity="sha512-SeiQaaDh73yrb56sTW/RgVdi/mMqNeM2oBwubFHagc5BkixSpP1fvqF47mKzPGWYSSy4RwbBunrJBQ4Co8fRWA==" crossorigin="anonymous"></script>
    

    
    

    
    
    
      
      <script id="search-hit-fuse-template" type="text/x-template">
        <div class="search-hit" id="summary-{{key}}">
          <div class="search-hit-content">
            <div class="search-hit-name">
              <a href="{{relpermalink}}">{{title}}</a>
              <div class="article-metadata search-hit-type">{{type}}</div>
              <p class="search-hit-description">{{snippet}}</p>
            </div>
          </div>
        </div>
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
      
    

    
    

    
    
    
    

    
    <script src="/js/bootstrap.bundle.min.6aed84840afc03ab4d5750157f69c120.js"></script>

    
    
      
      
      
      
      
      
      
    

    
    
    
    
    
    
    
    
      
      
    
    
    <script src="/en/js/wowchemy.min.4ea9cc8d09c5c158656ac1a804743b34.js"></script>

    
  <script async defer src="https://buttons.github.io/buttons.js"></script>




</body>
</html>
