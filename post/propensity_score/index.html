<!DOCTYPE html><html lang="en-us" >

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.1.0 for Hugo" />
  

  

  
  
  
  
  
    
    
    
  
  

  

  
  
  
    
  
  <meta name="description" content="In this tutorial, we are going to see how to estimate causal effects when the treatment is not unconditionally randomly assigned, but we need to condition on observable features in order to assume treatment exogeneity." />

  
  <link rel="alternate" hreflang="en-us" href="https://matteocourthoud.github.io/post/propensity_score/" />

  







  




  
  
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    <meta name="theme-color" content="#003f5c" />
  

  
  
    
    <script src="/js/mathjax-config.js"></script>
  

  
  
  
  
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin="anonymous">

    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css" integrity="sha512-1xoFisiGdy9nvho8EgXuXvnpR5GAMSjFwp40gSRE3NwdUdIMIKuPa7bqoUhLD0O/5tPNhteAsE5XyyMi5reQVA==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Source+Sans+Pro:wght@200;300;400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Source+Sans+Pro:wght@200;300;400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.4f7182ca394d705ee32d9d7750e9aa1d.css" />

  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-144780600-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'UA-144780600-1', { 'anonymize_ip': true });
  gtag('set', {'cookie_flags': 'SameSite=None;Secure'});

  
  document.addEventListener('click', onClickCallback, false);
</script>


  

  

  




  
  
  

  

  
    <link rel="manifest" href="/index.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu03e9b3967b83fd39296ec9da5ff1ea05_201175_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu03e9b3967b83fd39296ec9da5ff1ea05_201175_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://matteocourthoud.github.io/post/propensity_score/" />

  
  
  
  
  
  
  
  
    
  
  
  <meta property="twitter:card" content="summary_large_image" />
  
  <meta property="og:site_name" content="Matteo Courthoud" />
  <meta property="og:url" content="https://matteocourthoud.github.io/post/propensity_score/" />
  <meta property="og:title" content="Propensity Score Matching | Matteo Courthoud" />
  <meta property="og:description" content="In this tutorial, we are going to see how to estimate causal effects when the treatment is not unconditionally randomly assigned, but we need to condition on observable features in order to assume treatment exogeneity." /><meta property="og:image" content="https://matteocourthoud.github.io/post/propensity_score/featured.png" />
    <meta property="twitter:image" content="https://matteocourthoud.github.io/post/propensity_score/featured.png" /><meta property="og:locale" content="en-us" />
  
    
      <meta
        property="article:published_time"
        content="2022-04-15T00:00:00&#43;00:00"
      />
    
    <meta property="article:modified_time" content="2022-04-15T00:00:00&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://matteocourthoud.github.io/post/propensity_score/"
  },
  "headline": "Propensity Score Matching",
  
  "image": [
    "https://matteocourthoud.github.io/post/propensity_score/featured.png"
  ],
  
  "datePublished": "2022-04-15T00:00:00Z",
  "dateModified": "2022-04-15T00:00:00Z",
  
  "publisher": {
    "@type": "Organization",
    "name": "Matteo Courthoud",
    "logo": {
      "@type": "ImageObject",
      "url": "https://matteocourthoud.github.io/media/icon_hu03e9b3967b83fd39296ec9da5ff1ea05_201175_192x192_fill_lanczos_center_3.png"
    }
  },
  "description": "In this tutorial, we are going to see how to estimate causal effects when the treatment is not unconditionally randomly assigned, but we need to condition on observable features in order to assume treatment exogeneity."
}
</script>

  

  

  
  
  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.js" integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.css" integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin="anonymous">
  
  <script>
  window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#003f5c",
          "text": "rgb(255, 255, 255)"
        },
        "button": {
          "background": "rgb(255, 255, 255)",
          "text": "#003f5c"
        }
      },
      "theme": "classic",
      "content": {
        "message": "This website uses cookies to ensure you get the best experience on our website.",
        "dismiss": "Got it!",
        "link": "Learn more",
        "href": "/privacy/"
      }
    })});
  </script>


  





  <title>Propensity Score Matching | Matteo Courthoud</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="f430af05f2329e440db7e1f50ed7187c" >

  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.66d3e0fff6d32c4ece05adee927fbd96.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="Close"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="Search...">
        
      </div>

      
      

      

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    












<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container-xl">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">Matteo Courthoud</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">Matteo Courthoud</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-end" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#projects"><span>Research</span></a>
        </li>

        
        

        
        <li class="nav-item dropdown">
          <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>Courses</span><span class="caret"></span>
          </a>
          <div class="dropdown-menu">
            
              <a class="dropdown-item" href="/course/ml-econ/"><span>Machine Learning for Economics</span></a>
            
              <a class="dropdown-item" href="/course/data-science/"><span>Data Science with Python</span></a>
            
              <a class="dropdown-item" href="/course/empirical-io/"><span>PhD Industrial Organization</span></a>
            
              <a class="dropdown-item" href="/course/metrics/"><span>PhD Econometrics</span></a>
            
              <a class="dropdown-item" href="https://pp4rs.github.io/"><span>Programming Practices for Research</span></a>
            
          </div>
        </li>

        
        

        

        
        
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/cv"><span>CV</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

      
      
        
      

      
      

      
      

      
      

    </ul>

  </div>
</nav>


  </div>

  <div class="page-body">
    <div class="container-fluid docs">
  <div class="row">

    <div class="col-xl-2 col-lg-2 d-none d-xl-block d-lg-block empty">
    </div>

    <div class="col-2 col-xl-2 col-lg-2 d-none d-lg-block docs-toc">
      <ul class="nav toc-top">
        <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
      </ul>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#setting">Setting</a></li>
    <li><a href="#propensity-scores">Propensity Scores</a>
      <ul>
        <li><a href="#exogenous-treatment">Exogenous Treatment</a></li>
        <li><a href="#conditionally-exogenous-treatment">Conditionally Exogenous Treatment</a></li>
        <li><a href="#comments">Comments</a></li>
      </ul>
    </li>
    <li><a href="#academic-application">Academic Application</a>
      <ul>
        <li><a href="#experimental-data">Experimental Data</a></li>
        <li><a href="#observational-data">Observational Data</a></li>
        <li><a href="#inverse-propensity-score-weighting">Inverse propensity score weighting</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
    </div>

    <main class="col-xl-8 col-lg-8 docs-content" role="main">
        <article class="article">
        




















  


<div class="article-container pt-3">
  <h1>Propensity Score Matching</h1>

  

  


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    Apr 15, 2022
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    11 min read
  </span>
  

  
  
  
  
  
  

  
  

</div>

  





</div>


<div class="article-header article-container featured-image-wrapper mt-4 mb-4" style="max-width: 1229px; max-height: 780px;">
  <div style="position: relative">
    <img src="/post/propensity_score/featured.png" alt="" class="featured-image">
    
  </div>
</div>


        <div class="article-container">
          <div class="article-style" align="justify">
            <p>In this tutorial, we are going to see how to estimate causal effects when the treatment is not <em>unconditionally</em> randomly assigned, but we need to condition on observable features in order to assume treatment exogeneity. This might happen either when an experiment is stratified or in observational studies.</p>
<p><strong>Requisites</strong></p>
<p>For this tutorial, I assume you are familiar with the following concepts:</p>
<ul>
<li>Rubin&rsquo;s potential outcome framework</li>
<li>Ordinary least squares regression</li>
</ul>
<p><strong>Academic Application</strong></p>
<p>As an academic application, we are going to replicate <a href="https://www.jstor.org/stable/2937954" target="_blank" rel="noopener">Evaluating the Econometric Evaluations of Training Programs with Experimental Data</a> (1986) by Lalonde and the followup paper <a href="https://www.tandfonline.com/doi/abs/10.1080/01621459.1999.10473858" target="_blank" rel="noopener">Causal Effects in Non-Experimental Studies: Reevaluating the Evaluation of Training Programs</a> (1999) by Dahejia and Wahba. These papers study a randomized intervention providing work experienced to improve labor market outcomes.</p>
<p><strong>Business Case</strong></p>
<p>TBD</p>
<h2 id="setting">Setting</h2>
<p>We assume that for a set of i.i.d. subjects $i = 1, &hellip;, n$ we observed a tuple $(X_i, D_i, Y_i)$ comprised of</p>
<ul>
<li>a feature vector $X_i \in \mathbb R^n$</li>
<li>a treatment assignment $D_i \in \lbrace 0, 1 \rbrace$</li>
<li>a response $Y_i \in \mathbb R$</li>
</ul>
<p><strong>Assumption 1 : unconfoundedness</strong> (or ignorability, or selection on observables, or conditional independence)</p>
<p>$$
\big \lbrace Y_i^{(1)} , Y_i^{(0)} \big \rbrace \ \perp \ D_i \ | \ X_i
$$</p>
<p>i.e. conditional on observable characteristics $X$, the treatment assignment $T$ is as good as random. What this assumption rules out is <em>selection on unobservables</em>. Moreover, it&rsquo;s <em>untestable</em>.</p>
<p><strong>Assumption 2: overlap</strong> (or common support)</p>
<p>$$
\exists \eta &gt; 0 \ : \ \eta \leq \mathbb E \left[ D_i = 1 \ \big | \ X_i = x \right] \leq 1-\eta
$$</p>
<p>i.e. no observation is deterministically assigned to the treatment or control group. We need this assumption for counterfactual statements to make sense. If some observations had zero probability of (not) being treated, it would make no sense to try to estimate their counterfactual outcome in case they would have (not) being treated. Also this assumption is <em>untestable</em>.</p>
<p><strong>Assumption 3: stable unit treatment value (SUTVA)</strong></p>
<p>$$
Y_i^{(D_i)} \perp D_j \quad \forall j \neq i
$$</p>
<p>i.e. the potential outcome of one individual is independent from the treatment status of any other individual. Common <em>violations</em> of this assumption include</p>
<ul>
<li>general equilibrium effects</li>
<li>spillover effects</li>
</ul>
<p>This assumption is <em>untestable</em>.</p>
<h2 id="propensity-scores">Propensity Scores</h2>
<h3 id="exogenous-treatment">Exogenous Treatment</h3>
<p>The <strong>fundamental problem of causal inference</strong> is that we do not observe counterfactual outcomes, i.e. we do not observe what would have happened to treated units if they had not received the treatment and viceversa.</p>
<p>If treatment is exogenous, we know that the difference in means identifies the average treatment effect $\mathbb E[\tau]$.</p>
<p>$$
\mathbb E[\tau] = \mathbb E \big[ Y_i \ \big| \ D_i = 1 \big] - \mathbb E \big[ Y_i \ \big| \ D_i = 0 \big] = \mathbb E \big[ Y_{i}^{(1)} - Y_{i}^{(0)} \big]
$$</p>
<p>Therefore, we can build an unbiased estimator of the average treatment effect as the empirical counterpart of the expression above</p>
<p>$$
\hat \tau(Y, D) = \frac{1}{n} \sum_{i=1}^{n} \big( D_i Y_i - (1-D_i) Y_i \big)
$$</p>
<p>In case treatment is not randomly assigned, we use the Thompson Horowitz (1952) estimator</p>
<p>$$
\hat \tau(Y, D) = \frac{1}{n} \sum_{i=1}^{n} \left( \frac{D_i Y_i}{\pi_{i}} - \frac{(1-D_i) Y_i}{1 - \pi_{i}} \right)
$$</p>
<p>where $\pi_{i} = \Pr(D_i=1)$ is the probability of being treated, also known as <strong>propensity score</strong>. Sometimes the propensity score is known, for example when treatment is stratified. However, in general, it is not.</p>
<h3 id="conditionally-exogenous-treatment">Conditionally Exogenous Treatment</h3>
<p>In many cases and especially in observational studies, treatment $D$ is not unconditionally exogenous, but it&rsquo;s exogenous only after we condition on some characteristic $X$. If these characteristics are observables, we have the <strong>unconfoundedness</strong> assumption.</p>
<p>Under unconfoundedness, we can still identify the average treatment effect, as a <em>conditional</em> difference in means:</p>
<p>$$
\mathbb E[\tau] = \mathbb E \big[ Y_{i}^{(1)} - Y_{i}^{(0)} \ \big| \ X_i \big]
$$</p>
<p>The main problem is that we need to condition of the observables that actually make the unconfoundedness assumption hold. This might be tricky in two cases:</p>
<ol>
<li>when we have many observables</li>
<li>when we do not know the functional form of the observables that we need to condition on</li>
</ol>
<p>The main contribution of Rosenbaum and Rubin (1983) is to show that if <strong>unconfoundedness</strong> holds, then</p>
<p>$$
\big \lbrace Y_i^{(1)} , Y_i^{(0)} \big \rbrace \ \perp \ D_i \ | \ \pi(X_i)
$$</p>
<p>i.e. you only need to condition on $\pi(X)$ in order to recover the average treatment effect.</p>
<p>$$
\mathbb E[\tau] = \mathbb E \big[ Y_{i}^{(1)} - Y_{i}^{(0)} \ \big| \ \pi(X_i) \big]
$$</p>
<p>This implies the following <strong>inverse propensity-weighted</strong> estimator:</p>
<p>$$
\hat \tau^{IPW} = \frac{1}{n} \sum_{i=1}^{n} \left( \frac{D_i Y_i}{\hat \pi(X_i)} - \frac{(1-D_i) Y_i}{1 - \hat \pi(X_i)} \right)
$$</p>
<p>which, under <em>unconfoundedness</em> is an <strong>unbiased</strong> estimator of the average treatment effect, $\mathbb E \left[\hat \tau^{IPW} \right] = \tau$.</p>
<p>This is a very practically relevant result since it tells us that we need to condition on a single variable instead of a potentially infinite dimensional array. The only thing we need to do is to estimate $\pi(X_i)$.</p>
<h3 id="comments">Comments</h3>
<p><strong>Actual vs Estimated Scores</strong></p>
<p>Hirano and Ridder (2002) show that even when you know the true propensity score $\pi(X)$, it&rsquo;s better to plug in the estimated propensity score $\hat \pi(X)$. Why? The idea is that the deviation between the actual and the estimated propensity score is providing some additional information. Therefore, it is best to use the actual fraction of treated rather than the theoretical one.</p>
<p><strong>Propensity Scores and Regression</strong></p>
<p>What is the difference between running a regression with controls vs doing propensity score matching?</p>
<p>Aranow and Miller (2015) investigate this comparison in depth. First of all, whenever you are inserting <strong>control variables</strong> in a regression, you are implicitly thinking about propensity scores. Both approaches are implicitly estimating counterfactual outcomes. Usually OLS extrapolates further away from the actual support than propensity score does.</p>
<p>In the tweet (and its comments) below you can find further discussion and comments.</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Thank you for tolerating such a vague poll question. <br><br>Let me explain why I think this is a useful thing to bring front and certain, and highlight what I think is a flaw in how much of econometrics is taught, currently. <br><br>1/n <a href="https://t.co/Wm2jFereYO">pic.twitter.com/Wm2jFereYO</a></p>&mdash; Paul Goldsmith-Pinkham (@paulgp) <a href="https://twitter.com/paulgp/status/1470787510091632651?ref_src=twsrc%5Etfw">December 14, 2021</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<h2 id="academic-application">Academic Application</h2>
<p>As an academic application, we are going to replicate <a href="https://www.tandfonline.com/doi/abs/10.1080/01621459.1999.10473858" target="_blank" rel="noopener">Causal Effects in Non-Experimental Studies: Reevaluating the Evaluation of Training Programs</a> (1999) by Dahejia and Wahba.</p>
<p>This study builds on a previous study: <a href="https://www.jstor.org/stable/2937954" target="_blank" rel="noopener">Evaluating the Econometric Evaluations of Training Programs with Experimental Data</a> (1986) by Lalonde. In this study, the author compares observational and experimental methods. In particular, he studies an experimental intervention called the NSW (National Supported Work demonstration). The NSW is a temporary training program to give work experience to unemployed people.</p>
<p>The exogenous variation allows us to estimate the treatment effect as a difference in means. The author then asks: what if we didn&rsquo;t have access to an experiment? In particular, what if we did not have information on the control group? He takes a sample of untreated people from the PSID panel and use them as a control group.</p>
<h3 id="experimental-data">Experimental Data</h3>
<p>Let&rsquo;s start by loading the NSW data.</p>
<pre><code class="language-python">%matplotlib inline
%config InlineBackend.figure_format = 'retina'
</code></pre>
<pre><code class="language-python">from src.utils import *
</code></pre>
<pre><code class="language-python">df_nsw = pd.read_csv('data/l86_nsw.csv')
df_nsw.head()
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>treat</th>
      <th>age</th>
      <th>educ</th>
      <th>black</th>
      <th>hisp</th>
      <th>marr</th>
      <th>nodegree</th>
      <th>re74</th>
      <th>re75</th>
      <th>re78</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>37</td>
      <td>11</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>9930.045898</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>22</td>
      <td>9</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>3595.894043</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>30</td>
      <td>12</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>24909.449219</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>27</td>
      <td>11</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>7506.145996</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>33</td>
      <td>8</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>289.789886</td>
    </tr>
  </tbody>
</table>
</div>
<p>The treatment variable is <code>treat</code> and the outcome of interest is <code>re78</code>, the income in 1978. We also have access to a bunch of covariates.</p>
<pre><code class="language-python">y = 're78'
T = 'treat'
X = df_nsw.columns[2:9]
</code></pre>
<p>Was there selection on observables? Let&rsquo;s summarize the data, according to treatment status.</p>
<pre><code class="language-python">df_nsw.groupby('treat').agg(['mean', 'std']).T.unstack(1)
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead tr th {
    text-align: left;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>treat</th>
      <th colspan="2" halign="left">0</th>
      <th colspan="2" halign="left">1</th>
    </tr>
    <tr>
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>mean</th>
      <th>std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>age</th>
      <td>25.053846</td>
      <td>7.057745</td>
      <td>25.816216</td>
      <td>7.155019</td>
    </tr>
    <tr>
      <th>educ</th>
      <td>10.088462</td>
      <td>1.614325</td>
      <td>10.345946</td>
      <td>2.010650</td>
    </tr>
    <tr>
      <th>black</th>
      <td>0.826923</td>
      <td>0.379043</td>
      <td>0.843243</td>
      <td>0.364558</td>
    </tr>
    <tr>
      <th>hisp</th>
      <td>0.107692</td>
      <td>0.310589</td>
      <td>0.059459</td>
      <td>0.237124</td>
    </tr>
    <tr>
      <th>marr</th>
      <td>0.153846</td>
      <td>0.361497</td>
      <td>0.189189</td>
      <td>0.392722</td>
    </tr>
    <tr>
      <th>nodegree</th>
      <td>0.834615</td>
      <td>0.372244</td>
      <td>0.708108</td>
      <td>0.455867</td>
    </tr>
    <tr>
      <th>re74</th>
      <td>2107.026651</td>
      <td>5687.905639</td>
      <td>2095.573693</td>
      <td>4886.620354</td>
    </tr>
    <tr>
      <th>re75</th>
      <td>1266.909015</td>
      <td>3102.982088</td>
      <td>1532.055313</td>
      <td>3219.250879</td>
    </tr>
    <tr>
      <th>re78</th>
      <td>4554.801120</td>
      <td>5483.836001</td>
      <td>6349.143502</td>
      <td>7867.402183</td>
    </tr>
  </tbody>
</table>
</div>
<p>It seems that covariates are balanced across treatment arms. Nothing seems to point towards selection on observables. Therefore, we can compute the average treatment effect as a simple difference in means</p>
<pre><code class="language-python">df_nsw.loc[df_nsw[T]==1, y].mean() - df_nsw.loc[df_nsw[T]==0, y].mean()
</code></pre>
<pre><code>1794.3423818501024
</code></pre>
<p>Or equivalently in a regression</p>
<pre><code class="language-python">est = smf.ols('re78 ~ treat', df_nsw).fit()
est.summary().tables[1]
</code></pre>
<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td> 4554.8011</td> <td>  408.046</td> <td>   11.162</td> <td> 0.000</td> <td> 3752.855</td> <td> 5356.747</td>
</tr>
<tr>
  <th>treat</th>     <td> 1794.3424</td> <td>  632.853</td> <td>    2.835</td> <td> 0.005</td> <td>  550.574</td> <td> 3038.110</td>
</tr>
</table>
<p>It looks like the effect is positive and significant.</p>
<h3 id="observational-data">Observational Data</h3>
<p>Let&rsquo;s now load a different dataset in which we have replaced the true control units with observations from the PSID sample.</p>
<pre><code class="language-python">df_psid = pd.read_csv('data/l86_psid.csv')
</code></pre>
<p>Is this dataset balanced?</p>
<pre><code class="language-python">df_psid.groupby('treat').agg(['mean', 'std']).T.unstack(1)
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead tr th {
    text-align: left;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>treat</th>
      <th colspan="2" halign="left">0</th>
      <th colspan="2" halign="left">1</th>
    </tr>
    <tr>
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>mean</th>
      <th>std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>age</th>
      <td>36.094862</td>
      <td>12.081030</td>
      <td>25.816216</td>
      <td>7.155019</td>
    </tr>
    <tr>
      <th>educ</th>
      <td>10.766798</td>
      <td>3.176827</td>
      <td>10.345946</td>
      <td>2.010650</td>
    </tr>
    <tr>
      <th>black</th>
      <td>0.391304</td>
      <td>0.489010</td>
      <td>0.843243</td>
      <td>0.364558</td>
    </tr>
    <tr>
      <th>hisp</th>
      <td>0.067194</td>
      <td>0.250853</td>
      <td>0.059459</td>
      <td>0.237124</td>
    </tr>
    <tr>
      <th>marr</th>
      <td>0.735178</td>
      <td>0.442113</td>
      <td>0.189189</td>
      <td>0.392722</td>
    </tr>
    <tr>
      <th>nodegree</th>
      <td>0.486166</td>
      <td>0.500799</td>
      <td>0.708108</td>
      <td>0.455867</td>
    </tr>
    <tr>
      <th>re74</th>
      <td>11027.303390</td>
      <td>10814.670751</td>
      <td>2095.573693</td>
      <td>4886.620354</td>
    </tr>
    <tr>
      <th>re75</th>
      <td>7569.222058</td>
      <td>9041.944403</td>
      <td>1532.055313</td>
      <td>3219.250879</td>
    </tr>
    <tr>
      <th>re78</th>
      <td>9995.949977</td>
      <td>11184.450050</td>
      <td>6349.143502</td>
      <td>7867.402183</td>
    </tr>
  </tbody>
</table>
</div>
<p>People in the PSID control group are older, more educated, white, married and generally have considerably higher pre-intervention earnings (<code>re74</code>). This makes sense since the people selected for the NSW program are people that are younger, less experienced and unemployed.</p>
<p>Lalonde (1986) argues in favor of experimental approaches by showing that using a non-experimental setting, one would not be able to estimate the true treatment effect. Actually, one could even get statistically significant results of the opposite sign.</p>
<p>Let&rsquo;s repeat the regression exercise for the PSID data.</p>
<pre><code class="language-python">smf.ols('re78 ~ treat', df_psid).fit().summary().tables[1]
</code></pre>
<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td> 9995.9500</td> <td>  623.715</td> <td>   16.026</td> <td> 0.000</td> <td> 8770.089</td> <td> 1.12e+04</td>
</tr>
<tr>
  <th>treat</th>     <td>-3646.8065</td> <td>  959.704</td> <td>   -3.800</td> <td> 0.000</td> <td>-5533.027</td> <td>-1760.586</td>
</tr>
</table>
<p>The estimated coefficient is negative and significant. The conclusion from Lalonde (1986) is</p>
<blockquote>
<p>&ldquo;This comparison shows that many of the econometric procedures d not replicate the experimentally determined results&rdquo;.</p>
</blockquote>
<p>Dahejia and Wahba (1999) argue that with appropriate matching one would still be able to get a relatively precise estimate of the treatment effect. In particular, the argue in favor of controlling for pre-intervention income, <code>re74</code> and <code>re75</code>.</p>
<p>Let&rsquo;s just linearly insert the control variables in the regression.</p>
<pre><code class="language-python">smf.ols('re78 ~ treat + ' + ' + '.join(X), df_psid).fit().summary().tables[1]
</code></pre>
<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td>-1089.9263</td> <td> 2913.224</td> <td>   -0.374</td> <td> 0.708</td> <td>-6815.894</td> <td> 4636.042</td>
</tr>
<tr>
  <th>treat</th>     <td> 2642.1456</td> <td> 1039.655</td> <td>    2.541</td> <td> 0.011</td> <td>  598.694</td> <td> 4685.597</td>
</tr>
<tr>
  <th>educ</th>      <td>  521.5869</td> <td>  208.751</td> <td>    2.499</td> <td> 0.013</td> <td>  111.284</td> <td>  931.890</td>
</tr>
<tr>
  <th>black</th>     <td>-1026.6762</td> <td> 1006.433</td> <td>   -1.020</td> <td> 0.308</td> <td>-3004.830</td> <td>  951.478</td>
</tr>
<tr>
  <th>hisp</th>      <td> -903.1023</td> <td> 1726.419</td> <td>   -0.523</td> <td> 0.601</td> <td>-4296.394</td> <td> 2490.189</td>
</tr>
<tr>
  <th>marr</th>      <td> 1026.6143</td> <td>  943.788</td> <td>    1.088</td> <td> 0.277</td> <td> -828.410</td> <td> 2881.639</td>
</tr>
<tr>
  <th>nodegree</th>  <td>-1469.3712</td> <td> 1166.114</td> <td>   -1.260</td> <td> 0.208</td> <td>-3761.379</td> <td>  822.637</td>
</tr>
<tr>
  <th>re74</th>      <td>    0.1928</td> <td>    0.058</td> <td>    3.329</td> <td> 0.001</td> <td>    0.079</td> <td>    0.307</td>
</tr>
<tr>
  <th>re75</th>      <td>    0.4976</td> <td>    0.070</td> <td>    7.068</td> <td> 0.000</td> <td>    0.359</td> <td>    0.636</td>
</tr>
</table>
<p>The treatment effect is now positive, borderline significant, and close to the experimental estimate of $1794$$. Moreover, it&rsquo;s hard to tell whether this is the correct functional form for the control variables.</p>
<h3 id="inverse-propensity-score-weighting">Inverse propensity score weighting</h3>
<p>Another option is to use <strong>inverse propensity score weighting</strong>. First, we need to estimate the treatment probability. Let&rsquo;s start with a very simple standard model to predict binary outcomes.</p>
<pre><code class="language-python">from sklearn.linear_model import LogisticRegressionCV

pi = LogisticRegressionCV().fit(y=df_psid[T], X=df_psid[X])
df_psid['pscore'] = pi.predict_proba(df_psid[X])[:,1]
</code></pre>
<p>How does the distribution of the propensity scores look like?</p>
<pre><code class="language-python">sns.histplot(data=df_psid, x='pscore', hue=T, bins=20)\
.set(title='Distribution of propensity scores, PSID data', xlabel='');
</code></pre>
<p><img src="img/propensity_score_41_0.png" alt="png"></p>
<p>It seems that indeed we predict higher propensity scores for treated people, and viceversa, indicating a strong selection on observable. However, there is also a considerable amount of overlap.</p>
<p>We can now estimate the treatment effect by weighting by the inverse of the propensity score. First, let&rsquo;s exclude observations with a very extreme predicted score.</p>
<pre><code class="language-python">df_psid1 = df_psid[(df_psid['pscore']&lt;0.9) &amp; (df_psid['pscore']&gt;0.1)]
</code></pre>
<p>Now we can need to construct the weights.</p>
<pre><code class="language-python">df_psid1['weight'] = df_psid1['treat'] / df_psid1['pscore'] + (1-df_psid1['treat']) / (1-df_psid1['pscore'])
</code></pre>
<p>Finally, we run a weighted regression of income on the treatment program.</p>
<pre><code class="language-python">est = smf.wls('re78 ~ treat', df_psid1, weights=df_psid1['weight']).fit()
est.summary().tables[1]
</code></pre>
<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td> 4038.1507</td> <td>  512.268</td> <td>    7.883</td> <td> 0.000</td> <td> 3030.227</td> <td> 5046.074</td>
</tr>
<tr>
  <th>treat</th>     <td> 2166.8750</td> <td>  730.660</td> <td>    2.966</td> <td> 0.003</td> <td>  729.250</td> <td> 3604.500</td>
</tr>
</table>
<p>The effect is positive, statistically significant and very close to the experimental estimate of $1794$$.</p>
<p>What would have been the propensity scores if we had used the NSW experimental sample? If it&rsquo;s a well done experiment with a sufficiently large sample, we would expect the propensity scores to concentrate around the percentage of people treated, $0.41$ in our data.</p>
<pre><code class="language-python">pi = LogisticRegressionCV().fit(y=df_nsw[T], X=df_nsw[X])
df_nsw['pscore'] = pi.predict_proba(df_nsw[X])[:,1]
</code></pre>
<pre><code class="language-python">sns.histplot(data=df_nsw, x='pscore', hue=T, bins=20)\
.set(title='Distribution of propensity scores, NSW data', xlabel='');
</code></pre>
<p><img src="img/propensity_score_50_0.png" alt="png"></p>
<p>Indeed, now the distribution of the p-scores is concentrated around the treatment frequency in the data. Remarkably, the standard deviation is extremely tight.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://academic.oup.com/biomet/article/70/1/41/240879" target="_blank" rel="noopener">The central role of the propensity score in observational studies for causal effects</a> (1983) by Rosenbaum and Rubin</li>
<li><a href="https://www.youtube.com/watch?v=8gWctYvRzk4" target="_blank" rel="noopener">Propensity Scores</a> video lecture by Paul Goldsmith-Pinkham (Yale)</li>
<li><a href="https://www.youtube.com/watch?v=m3Y8heXoDxE" target="_blank" rel="noopener">Propensity Scores</a> video lecture by Stefan Wager (Stanford)</li>
</ul>

          </div>
          


















  
  



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="https://matteocourthoud.github.io/"><img class="avatar mr-3 avatar-circle" src="/author/avatar_hu365eedc833ccd5578a90de7c849ec45e_385094_270x270_fill_q75_lanczos_center.jpg" alt=""></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://matteocourthoud.github.io/"></a></h5>
      
      <p class="card-text">I hold a PhD in economics from the University of Zurich. Now I work at the intersection of economics, data science and statistics. I regularly write about causal inference on <a href="https://medium.com/@matteo.courthoud" target="_blank" rel="noopener">Medium</a>.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://medium.com/@matteo.courthoud" target="_blank" rel="noopener">
        <i class="fab fa-medium"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/matteo-courthoud-7335198a/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/MatteoCourthoud/" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/matteocourthoud" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://open.spotify.com/user/1180947523" target="_blank" rel="noopener">
        <i class="fab fa-spotify"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>
















  
  




        </div>
        </article>
    </main>
  </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  

  
  <p class="powered-by">
    
      <a href="/privacy/">Privacy Policy</a>
    
    
       &middot; 
      <a href="/terms/">Terms</a>
    
  </p>
  

  

  
  







</footer>

    </div>
    
  </div>

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js" integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin="anonymous"></script>

      
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.8.4/mermaid.min.js" integrity="sha512-as1BF4+iHZ3BVO6LLDQ7zrbvTXM+c/1iZ1qII/c3c4L8Rn5tHLpFUtpaEtBNS92f+xGsCzsD7b62XP3XYap6oA==" crossorigin="anonymous" title="mermaid"></script>
      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js" integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/python.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/julia.min.js"></script>
        
      

    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js" integrity="sha512-SeiQaaDh73yrb56sTW/RgVdi/mMqNeM2oBwubFHagc5BkixSpP1fvqF47mKzPGWYSSy4RwbBunrJBQ4Co8fRWA==" crossorigin="anonymous"></script>
    

    
    

    
    
    
      
      <script id="search-hit-fuse-template" type="text/x-template">
        <div class="search-hit" id="summary-{{key}}">
          <div class="search-hit-content">
            <div class="search-hit-name">
              <a href="{{relpermalink}}">{{title}}</a>
              <div class="article-metadata search-hit-type">{{type}}</div>
              <p class="search-hit-description">{{snippet}}</p>
            </div>
          </div>
        </div>
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
      
    

    
    

    
    
    
    

    
    <script src="/js/bootstrap.bundle.min.6aed84840afc03ab4d5750157f69c120.js"></script>

    
    
      
      
      
      
      
      
      
    

    
    
    
    
    
    
    
    
      
      
    
    
    <script src="/en/js/wowchemy.min.4ea9cc8d09c5c158656ac1a804743b34.js"></script>

    
  <script async defer src="https://buttons.github.io/buttons.js"></script>




</body>
</html>
