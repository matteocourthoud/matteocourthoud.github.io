<!DOCTYPE html><html lang="en-us" >

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.1.0 for Hugo" />
  

  

  
  
  
  
  
    
    
    
  
  

  

  
  
  
    
  
  <meta name="description" content="How to estimate and do inference in click-through rates, returns of investment and more.
Some of the most common outcome metrics or key performance indicators (KPI) in the industry are ratios: click-through rates (clicks over views), returns on investment (revenue over cost), relative improvements (new outcome over old outcome), just to name few." />

  
  <link rel="alternate" hreflang="en-us" href="https://matteocourthoud.github.io/post/delta/" />

  







  




  
  
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    <meta name="theme-color" content="#003f5c" />
  

  
  
    
    <script src="/js/mathjax-config.js"></script>
  

  
  
  
  
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin="anonymous">

    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css" integrity="sha512-1xoFisiGdy9nvho8EgXuXvnpR5GAMSjFwp40gSRE3NwdUdIMIKuPa7bqoUhLD0O/5tPNhteAsE5XyyMi5reQVA==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Source+Sans+Pro:wght@200;300;400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Source+Sans+Pro:wght@200;300;400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.5c4def4f00a521426f4eb098155f3342.css" />

  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-144780600-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'UA-144780600-1', { 'anonymize_ip': true });
  gtag('set', {'cookie_flags': 'SameSite=None;Secure'});

  
  document.addEventListener('click', onClickCallback, false);
</script>


  

  

  




  
  
  

  

  
    <link rel="manifest" href="/index.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu03e9b3967b83fd39296ec9da5ff1ea05_201175_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu03e9b3967b83fd39296ec9da5ff1ea05_201175_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://matteocourthoud.github.io/post/delta/" />

  
  
  
  
  
  
  
  
    
  
  
  <meta property="twitter:card" content="summary_large_image" />
  
  <meta property="og:site_name" content="Matteo Courthoud" />
  <meta property="og:url" content="https://matteocourthoud.github.io/post/delta/" />
  <meta property="og:title" content="Experiments with Ratio Outcomes | Matteo Courthoud" />
  <meta property="og:description" content="How to estimate and do inference in click-through rates, returns of investment and more.
Some of the most common outcome metrics or key performance indicators (KPI) in the industry are ratios: click-through rates (clicks over views), returns on investment (revenue over cost), relative improvements (new outcome over old outcome), just to name few." /><meta property="og:image" content="https://matteocourthoud.github.io/post/delta/featured.png" />
    <meta property="twitter:image" content="https://matteocourthoud.github.io/post/delta/featured.png" /><meta property="og:locale" content="en-us" />
  
    
      <meta
        property="article:published_time"
        content="2022-12-23T00:00:00&#43;00:00"
      />
    
    <meta property="article:modified_time" content="2022-12-23T00:00:00&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://matteocourthoud.github.io/post/delta/"
  },
  "headline": "Experiments with Ratio Outcomes",
  
  "image": [
    "https://matteocourthoud.github.io/post/delta/featured.png"
  ],
  
  "datePublished": "2022-12-23T00:00:00Z",
  "dateModified": "2022-12-23T00:00:00Z",
  
  "publisher": {
    "@type": "Organization",
    "name": "Matteo Courthoud",
    "logo": {
      "@type": "ImageObject",
      "url": "https://matteocourthoud.github.io/media/icon_hu03e9b3967b83fd39296ec9da5ff1ea05_201175_192x192_fill_lanczos_center_3.png"
    }
  },
  "description": "How to estimate and do inference in click-through rates, returns of investment and more.\nSome of the most common outcome metrics or key performance indicators (KPI) in the industry are ratios: click-through rates (clicks over views), returns on investment (revenue over cost), relative improvements (new outcome over old outcome), just to name few."
}
</script>

  

  

  
  
  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.js" integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.css" integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin="anonymous">
  
  <script>
  window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#003f5c",
          "text": "rgb(255, 255, 255)"
        },
        "button": {
          "background": "rgb(255, 255, 255)",
          "text": "#003f5c"
        }
      },
      "theme": "classic",
      "content": {
        "message": "This website uses cookies to ensure you get the best experience on our website.",
        "dismiss": "Got it!",
        "link": "Learn more",
        "href": "/privacy/"
      }
    })});
  </script>


  





  <title>Experiments with Ratio Outcomes | Matteo Courthoud</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="778d1b1ce0a2ca288360e5d99c84092a" >

  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.6edaf3b475ce43de30d98828aea698be.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="Close"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="Search...">
        
      </div>

      
      

      

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    












<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container-xl">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">Matteo Courthoud</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">Matteo Courthoud</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-end" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#projects"><span>Research</span></a>
        </li>

        
        

        
        <li class="nav-item dropdown">
          <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>Courses</span><span class="caret"></span>
          </a>
          <div class="dropdown-menu">
            
              <a class="dropdown-item" href="/course/ml-econ/"><span>Machine Learning for Economics</span></a>
            
              <a class="dropdown-item" href="/course/data-science/"><span>Data Science with Python</span></a>
            
              <a class="dropdown-item" href="/course/empirical-io/"><span>PhD Industrial Organization</span></a>
            
              <a class="dropdown-item" href="/course/metrics/"><span>PhD Econometrics</span></a>
            
              <a class="dropdown-item" href="https://pp4rs.github.io/"><span>Programming Practices for Research</span></a>
            
          </div>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link  active" href="/post/"><span>Posts</span></a>
        </li>

        
        

        

        
        
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/cv"><span>CV</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

      
      
        
      

      
      

      
      

      
      

    </ul>

  </div>
</nav>


  </div>

  <div class="page-body">
    <div class="container-fluid docs">
  <div class="row">

    <div class="col-xl-2 col-lg-2 d-none d-xl-block d-lg-block empty">
    </div>

    <div class="col-2 col-xl-2 col-lg-2 d-none d-lg-block docs-toc">
      <ul class="nav toc-top">
        <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
      </ul>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#clicks-and-ads">Clicks and Ads</a></li>
    <li><a href="#the-delta-method">The Delta Method</a></li>
  </ul>

  <ul>
    <li><a href="#inference-with-linear-regression">Inference with Linear Regression</a></li>
    <li><a href="#conclusion">Conclusion</a>
      <ul>
        <li><a href="#references">References</a></li>
        <li><a href="#related-articles">Related Articles</a></li>
        <li><a href="#code">Code</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <main class="col-xl-8 col-lg-8 docs-content" role="main">
        <article class="article">
        




















  


<div class="article-container pt-3">
  <h1>Experiments with Ratio Outcomes</h1>

  

  


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    Dec 23, 2022
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    11 min read
  </span>
  

  
  
  
  
  
  

  
  

</div>

  





</div>


<div class="article-header article-container featured-image-wrapper mt-4 mb-4" style="max-width: 1152px; max-height: 768px;">
  <div style="position: relative">
    <img src="/post/delta/featured.png" alt="" class="featured-image">
    
  </div>
</div>


        <div class="article-container">
          <div class="article-style" align="justify">
            <p><em>How to estimate and do inference in click-through rates, returns of investment and more.</em></p>
<p>Some of the most common outcome metrics or <strong>key performance indicators (KPI)</strong> in the industry are <strong>ratios</strong>: click-through rates (clicks over views), returns on investment (revenue over cost), relative improvements (new outcome over old outcome), just to name few. If you want to investigate the causal effect of a treatment of interest (new product, new feature, new interface, &hellip;) on these outcomes, the gold standard are randomized control trials, a.k.a. <strong>AB tests</strong>. Randomly assigning the treatment to a subset of the population (users, patients, customers, &hellip;) we ensure that, on average, the only difference in outcomes can be attributed to the treatment. However, when the outcome is a ratio of two metrics, AB tests present some additional problems.</p>
<p>The first problem is that the estimator is biased. Even though one can estimate numerator and denominator without bias, the estimate of the ration will be biased. Second, computing a conference interval is not trivial and often people resort to bootstrapping, which is computationally intensive. However, a simple solutions exists.</p>
<p>In this post we are going to see how to solve both problems. First, we are going to apply a bias correction to the estimate. Second, we are going to explore a very powerful tool for inference with complex metrics: the <strong>delta method</strong>. While the algebra can be intense, the result is simple: we can compute the confidence interval for our ratio estimator using a simple linear regression.</p>
<h2 id="clicks-and-ads">Clicks and Ads</h2>
<p>To better illustrate the concepts, we are going to use a toy example throughout the article. Support we were a <strong>food delivery</strong> company that is testing a new UI for their landing page. The object of interest is the <strong>incremental click-through ratio (CTR)</strong>: does the number of clicks per view increase?</p>
<p>$$
\text{ctr} = \frac{\text{incremental number of clicks}}{\text{incremental number of views}} = \frac{\mathbb E [\Delta C]}{\mathbb E [\Delta V]}
$$</p>
<p>Differently from usual AB tests or randomized experiments, we are not interested in a single difference, but in the <strong>ratio</strong> of two differences: the effect on page views and the effect on clicks. We will still use a <strong>randomized control trial</strong> or <strong>AB test</strong> to estimate the incremental CTR: randomly assign users to either a treatment control condition. The treated users will see the new landing page, while the control users will see the old one. Randomization ensures that we can estimate the impact of the new landing page on either clicks or views by comparing users in the treatment and control group: the difference in their average is an unbiased estimator of the average treatment effect. However, things are more complicated for their ratio.</p>
<p>I import the data generating process <code>dgp_loyalty()</code> from <a href="https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/src/dgp.py" target="_blank" rel="noopener"><code>src.dgp</code></a>. I also import some plotting functions and libraries from <a href="https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/src/utils.py" target="_blank" rel="noopener"><code>src.utils</code></a>.  To include not only code but also data and tables, I use <a href="https://deepnote.com" target="_blank" rel="noopener">Deepnote</a>, a Jupyter-like web-based collaborative notebook environment.</p>
<pre><code class="language-python">%matplotlib inline
%config InlineBackend.figure_format = 'retina'

from src.utils import *
from src.dgp import dgp_clicks
</code></pre>
<pre><code class="language-python">dgp = dgp_clicks(outcome_vars=['views', 'clicks'],
                 assignment_var='new_ui',
                 n=10_000,
                 p=0.5)
df = dgp.generate_data()
df.head()
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>new_ui</th>
      <th>views</th>
      <th>clicks</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>11.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>3.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>5.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>2.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>1.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div>
<p>The data contains information on the number of page <code>views</code> and <code>clicks</code> for a set of $10.000$ users over a period of a month. We also have information on the <code>treatment</code>: the new landing page.  As it often happens with business metrics, both distributions of views and clicks are very <strong>skewed</strong>.</p>
<pre><code class="language-python">fix, (ax1, ax2) = plt.subplots(1, 2, figsize=(15, 5))
sns.histplot(df.views, ax=ax1, color='C0', bins=30).set(title='Distribution of Views')
sns.histplot(df.clicks, ax=ax2, color='C1', binwidth=.3).set(title='Distribution of Clicks');
</code></pre>
<p><img src="img/delta_8_0.png" alt="png"></p>
<p>We can compute the difference-in-means estimate by regressing the outcome on the treatment indicator.</p>
<pre><code class="language-python">smf.ols('views ~ new_ui', data=df).fit().summary().tables[1]
</code></pre>
<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td>    6.2164</td> <td>    0.092</td> <td>   67.597</td> <td> 0.000</td> <td>    6.036</td> <td>    6.397</td>
</tr>
<tr>
  <th>new_ui</th>    <td>    2.4971</td> <td>    0.131</td> <td>   19.077</td> <td> 0.000</td> <td>    2.241</td> <td>    2.754</td>
</tr>
</table>
<p>The number of views has increased by ???. What about clicks?</p>
<pre><code class="language-python">smf.ols('clicks ~ new_ui', data=df).fit().summary().tables[1]
</code></pre>
<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td>    0.1074</td> <td>    0.012</td> <td>    8.761</td> <td> 0.000</td> <td>    0.083</td> <td>    0.131</td>
</tr>
<tr>
  <th>new_ui</th>    <td>    0.6734</td> <td>    0.017</td> <td>   38.582</td> <td> 0.000</td> <td>    0.639</td> <td>    0.708</td>
</tr>
</table>
<p>Also the number of clicks has increased, by ???. What about their ratio?</p>
<p>We can estimate the incremental click-through rate as the ratio of the two previous estimates: the difference between the average clicks in the treatment minus control group, over the difference between the average views in the treatment minus control group.</p>
<p>$$
\hat{\text{ctr}} = \frac{\mathbb E_n [\Delta C]}{\mathbb E_n [\Delta V]}
$$</p>
<p>Note a subtle but crucial difference with respect to the previous formula: we have replaced the <a href="https://en.wikipedia.org/wiki/Expected_value" target="_blank" rel="noopener">expected values</a> $\mathbb E$ with the empirical expectation operators $\mathbb E_n$, also known as the <a href="https://en.wikipedia.org/wiki/Arithmetic_mean" target="_blank" rel="noopener">sample average</a>. The difference in notation is minimal, but the conceptual difference is huge. The first, $\mathbb E$, is a <strong>theoretical</strong> concept, while the second $\mathbb E_n$, while the second one is <strong>empirical</strong>: it is a number that depends on the actual data. I personally like the notation since it highlights the close link between the two concepts (the second is the empirical counterpart of the first), while also making it clear that the second crucially depends on the sample size $n$.</p>
<pre><code class="language-python">def estimate_ctr(df):
    clicks = df.loc[df.new_ui==1, &quot;clicks&quot;].mean() - df.loc[df.new_ui==0, &quot;clicks&quot;].mean()
    views = df.loc[df.new_ui==1, &quot;views&quot;].mean() - df.loc[df.new_ui==0, &quot;views&quot;].mean()
    return clicks / views
</code></pre>
<pre><code class="language-python">estimate_ctr(df)
</code></pre>
<pre><code>0.26966010738038276
</code></pre>
<p>The estimate is $0.2697$: for each additional page view, there is a 27% that the user clicks on the page. How much should we trust this number? Is it significantly different form zero, or it is just driven by noise?</p>
<p>To answer this question, we would like to compute a <a href="https://en.wikipedia.org/wiki/Confidence_interval" target="_blank" rel="noopener"><strong>confidence interval</strong></a>. How do we compute a a confidence interval for a ratio metric? The first step is to compute the standard deviation of the estimator.</p>
<p>One method that is always available is the <a href="https://en.wikipedia.org/wiki/Bootstrapping_%28statistics%29" target="_blank" rel="noopener"><strong>bootstrap</strong></a>: resample the data with replacement multiple and times and use the distribution of the estimates over samples to compute the standard deviation of the estimator.</p>
<p>Let&rsquo;s try it in our case. I compute the standard deviation over $10.000$ bootstrapped samples, using the function <code>pd.DataFrame().sample()</code> to sample with replacement.</p>
<pre><code class="language-python">np.std([estimate_ctr(df.sample(frac=1, replace=True, random_state=i)) for i in range(10_000)])
</code></pre>
<pre><code>0.016079944440980785
</code></pre>
<p>The bootstrap estimate of the standard deviation is equal to $0.0160$. How good is it?</p>
<p>Since we fully control the data generating process, we can simulate the &ldquo;true&rdquo; distribution of the estimator. We do that for $10.000$ simulations and we compute the resulting standard deviation of the estimator.</p>
<pre><code class="language-python">np.std(dgp.evaluate_f_redrawing_outcomes(estimate_ctr, 10_000))
</code></pre>
<pre><code>0.015475230927575944
</code></pre>
<p>The &ldquo;true&rdquo; variance of the estimator seems to be lower, around $0.0154$. The issue might be related to the fact that the bootstrap is particularly volatile with skewed distributions. One solution is the <a href="https://medium.com/towards-data-science/the-bayesian-bootstrap-6ca4a1d45148" target="_blank" rel="noopener"><strong>bayesian boostrap</strong></a> that I have covered in a separate post.</p>
<p>We are now going to explore another <em>extremely</em> powerful alternative, the <a href="https://en.wikipedia.org/wiki/Delta_method" target="_blank" rel="noopener"><strong>delta method</strong></a>. The delta method generally allows us to do inference on functions of random variable, therefore it&rsquo;s applications are broader than ratios. However, I don&rsquo;t think there is an easy way to approach the delta method, so the next section is going to be algebra-intense. If you want, you can skip it and go straight to the last section.</p>
<h2 id="the-delta-method">The Delta Method</h2>
<p>What is the <strong>Delta Method</strong>? In short, it is an incredibly powerful <strong>asymptotic inference</strong> method for functions of random variables, that exploits Taylor expansions. In short, the Delta Method requires four ingredients</p>
<ul>
<li>One or more <a href="https://en.wikipedia.org/wiki/Random_variable" target="_blank" rel="noopener">random variables</a></li>
<li>A function</li>
<li><a href="https://en.wikipedia.org/wiki/Central_limit_theorem" target="_blank" rel="noopener">The Central Limit Theorem</a></li>
<li><a href="https://en.wikipedia.org/wiki/Taylor_series" target="_blank" rel="noopener">Taylor expansions</a></li>
</ul>
<p>I will assume some basic knowledge of all four concepts. Suppose we had a set of realizations $X_1$, &hellip;, $X_n$ of a random variable that satisfy the requirements for the Central Limit Theorem (CLT): independence, identically distributed with expected value $\mu$ and finite variance $\sigma^2$. Under these conditions, the CLT tells us that the distribution of the sample average $\mathbb E_n[X]$ converges in distribution to a normal distribution, or more precisely</p>
<p>$$
\sqrt{n} \ \frac{ \mathbb E_n[X] - \mu}{\sigma} \ \overset{D}{\to} \ N(0, 1)
$$</p>
<p>What does the equation mean? It reads &ldquo;the normalized sample average, scaled by a factor $\sqrt{n}$, converges in distribution to a standard normal distribution, i.e. it is approximately Gaussian for a sufficiently large sample.</p>
<p>Now, suppose we were interested in a <strong>function</strong> of the sample average $f\big(\mathbb E_n[X]\big)$ instead of the sample average $\mathbb E_n[X]$. Note that this is different from the average of the function $\mathbb E_n\big[f(X)\big]$. The Delta Method tells us what the function of the sample average $f(\bar X)$ converges in distribution to.</p>
<p>$$
\sqrt{n} \ \frac{ f\big(\mathbb E_n[X]\big) - f(\mu)}{\sigma} \ \overset{D}{\to} \ N \big(0, f'(\mu)^2 \big)
$$</p>
<p>, where $f'(\mu)^2$ is the derivative of the function $f$, evaluated at $\mu$.</p>
<p>The result directly follows from the Taylor approximation of $ff\big(\mathbb E_n[X]\big)$</p>
<p>$$
f\big(\mathbb E_n[X]\big) = f(\mu) + f'(\mu) (\mathbb E_n[X] - \mu) + O \big\lbrace (\mathbb E_n[X] - \mu)^2 \big\rbrace
$$</p>
<p>Importantly, asymptotically, the last term disappears and the linear approximation holds exactly!</p>
<p>How is this connected to the ratio estimator? We need a bit more math and to switch from a single dimension to two dimensions in order to understand that. In our case, we have a bivariate function that input two random variables, $\Delta C$ and $\Delta V$ and returns their ratio. In the case of a multivariate function $f$, the asymptotic variance of the estimator is given by</p>
<p>$$
\text{AVar} \big( \hat{\text{ctr}} \big) = \nabla \hat{\text{ctr}}' \Sigma_n \nabla \hat{\text{ctr}}
$$</p>
<p>where, $\nabla$ indicates the <a href="https://en.wikipedia.org/wiki/Gradient" target="_blank" rel="noopener">gradient</a> of the function, i.e. the vector of directional derivatives, and $\Sigma_n$ is the empirical variance-covariance matrix of $X$. In our case, they correspond to</p>
<h1 id="nabla-hattextctr">$$
\begin{align*}
\nabla \hat{\text{ctr}}</h1>
<p>\begin{bmatrix}
\frac{1}{\mathbb E_n [\Delta V]} \ - \frac{\mathbb E_n [\Delta C]}{\mathbb E_n [\Delta V]^2}
\end{bmatrix}
\end{align*}
$$</p>
<p>and</p>
<p>$$
\begin{align*}
\Sigma_n =
\begin{bmatrix}
\text{Var}_n (\Delta C) &amp; \text{Cov}_n (\Delta C, \Delta V) \
\text{Cov}_n (\Delta C, \Delta V) &amp; \text{Var}_n (\Delta V) \
\end{bmatrix}
\end{align*}
$$</p>
<p>, where the subscripts $n$ indicate the empirical counterparts, as for the expected value. With a little matrix algebra, we get the formula of the asymptotic variance of the ratio estimator.</p>
<p>$$
\begin{align*}
\text{AVar} \big( \hat{\text{ctr}} \big) &amp;= \frac{1}{\mathbb E_n[\Delta V]^2} \text{Var}_n(\Delta C) - 2 \frac{\mathbb E_n[\Delta C]}{\mathbb E_n[\Delta V]^3} \text{Cov}_n(\Delta V, \Delta C) + \frac{\mathbb E_n[\Delta C]^2}{\mathbb E_n[\Delta V]^4} \text{Var}_n(\Delta V)
\end{align*}
$$</p>
<p>Importantly, we can rewrite the variance noting that the estimator is given by $\hat{\text{ctr}} = \frac{\mathbb E_n[\Delta C]}{\mathbb E_n[\Delta V]}$</p>
<p>$$
\begin{align*}
\text{AVar} \big( \hat{\text{ctr}} \big) = \frac{1}{\mathbb E_n[\Delta V]^2} \text{Var}_n \Big( \Delta C - \hat{\text{ctr}} \Delta V \Big) = \frac{1}{\mathbb E_n[\Delta V]^2} \text{Var}_n \Big( \Delta \big( C - \hat{\text{ctr}} V \big) \Big)
\end{align*}
$$</p>
<p>The last expression is very interesting because it suggests that we can estimate the standard deviation of our estimator by <strong>linear regression</strong>.</p>
<h2 id="inference-with-linear-regression">Inference with Linear Regression</h2>
<p>Did you skip the previous section? No problem!</p>
<p>After some algebra, we concluded that we can estimate the variance of our estimator as</p>
<p>$$
\begin{align*}
\text{AVar} \big( \hat{\text{ctr}} \big) = \frac{1}{\mathbb E_n[\Delta V]^2} \text{Var}_n \big( \Delta \tilde C \big)
\end{align*}
$$</p>
<p>, where $\tilde C = C - \hat{\text{ctr}} V$. This expression might seem obscure at first, but it is incredibly useful. In fact, it gives us (1) an intuitive <strong>interpretation</strong> of the variance of the estimator and (2) a <strong>practical</strong> way to estimate it.</p>
<p>Interpretation first! How should we read the above expression? We can estimate the variance of the empirical estimator as the variance of a difference-in-means estimator, for a new variable $\tilde C$ that we can easily compute from the data. We just need to scale it down by $\mathbb E_n[\Delta V]^2$. Therefore, the variance is decreasing in the causal effect of the treatment on the views $V$.</p>
<p>Now, let&rsquo;s use the equation above to estimate the variance of the click-through rate estimator, in <strong>three steps</strong>.</p>
<ol>
<li>The term $\mathbb E_n[\Delta V]$ is the difference in average views between the treatment and control group.</li>
</ol>
<pre><code class="language-python">e_delta_v = df.views[df.new_ui==1].mean() - df.views[df.new_ui==0].mean()
</code></pre>
<ol start="2">
<li>The variable $\tilde C$ is the number of clicks $C$ minus the number of views $V$, scaled by the estimated click-through rate $\hat{\text{ctr}}$.</li>
</ol>
<pre><code class="language-python">df['clicks_tilde'] = df['clicks'] - estimate_ctr(df) * df['views'] 
</code></pre>
<ol start="3">
<li>The variance of the treatment-control difference $\Delta \tilde C$ can be directly computed by linear regression, as in randomized controlled trials for difference-in-means estimators (for more details see Agrist and Pischke, 2008).</li>
</ol>
<pre><code class="language-python">sd_err = smf.ols('clicks_tilde ~ new_ui', df).fit().bse[1]
</code></pre>
<p>We now have all the ingredients to compute the standard deviation of the estimator..</p>
<pre><code class="language-python">sd_err / np.abs(e_delta_v)
</code></pre>
<pre><code>0.01566505344911916
</code></pre>
<p>We have estimated the variance of the ratio estimator with a simple linear regression! The estimated value $0.0156$ is very close to the &ldquo;true&rdquo; value of $0.0152$ and significantly faster than the bootstrap (around 1000 times faster on my machine).</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this article, we have explore a very common causal inference problem in the inference: assessing the effects of a treatment on an outcome metric. The additional complications come from the fact that we are studying not one, but two causal effects, intertwined. The effects are both first- and second-order. First, the estimator is biased. Second, computing the variance of the estimator is not trivial.</p>
<p>We have explored an incredibly powerful method to do inference for complex random variables: the <strong>delta method</strong>. In the particular case of ratio metrics, the delta method delivers a very insightful and practical functional form for the asymptotic variance of the estimator that can be estimated with a simple linear regression.</p>
<h3 id="references">References</h3>
<p>[1] A. Deng, U. Knoblich, J. Lu, <a href="https://arxiv.org/pdf/1803.06336.pdf" target="_blank" rel="noopener">Applying the Delta Method in Metric Analytics: A Practical Guide with Novel Ideas</a> (2018).</p>
<p>[2] R. Budylin, A. Drutsa, I. Katsev, V. Tsoy, <a href="https://dl.acm.org/doi/abs/10.1145/3159652.3159699" target="_blank" rel="noopener">Consistent Transformation of Ratio Metrics for Efficient Online Controlled Experiments</a> (2018). <em>ACM</em>.</p>
<p>[3] J. Angrist, J. Pischke, <a href="https://www.mostlyharmlesseconometrics.com/" target="_blank" rel="noopener">Mostly harmless econometrics: An empiricist&rsquo;s companion</a> (2009). <em>Princeton university press</em>.</p>
<h3 id="related-articles">Related Articles</h3>
<ul>
<li><a href="https://medium.com/towards-data-science/the-bayesian-bootstrap-6ca4a1d45148" target="_blank" rel="noopener">The Bayesian Bootstrap</a></li>
</ul>
<h3 id="code">Code</h3>
<p>You can find the original Jupyter Notebook here:</p>
<p><a href="https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/delta.ipynb" target="_blank" rel="noopener">https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/delta.ipynb</a></p>

          </div>
          








<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://matteocourthoud.github.io/post/delta/&amp;text=Experiments%20with%20Ratio%20Outcomes" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://matteocourthoud.github.io/post/delta/&amp;t=Experiments%20with%20Ratio%20Outcomes" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Experiments%20with%20Ratio%20Outcomes&amp;body=https://matteocourthoud.github.io/post/delta/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://matteocourthoud.github.io/post/delta/&amp;title=Experiments%20with%20Ratio%20Outcomes" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=Experiments%20with%20Ratio%20Outcomes%20https://matteocourthoud.github.io/post/delta/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://t.me/share/url?url=https://matteocourthoud.github.io/post/delta/&amp;text=%7btext%7d" target="_blank" rel="noopener" class="share-btn-telegram">
          <i class="fab fa-telegram"></i>
        </a>
      </li>
    
  </ul>
</div>











  
  



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="https://matteocourthoud.github.io/"><img class="avatar mr-3 avatar-circle" src="/author/avatar_hu365eedc833ccd5578a90de7c849ec45e_385094_270x270_fill_q75_lanczos_center.jpg" alt=""></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://matteocourthoud.github.io/"></a></h5>
      
      <p class="card-text">My research fields are empirical Industrial Organization and Competition Policy. My research interests include the relationship between competition and innovation, big data, artificial intelligence, platform markets, peer to peer services.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://medium.com/@matteo.courthoud" target="_blank" rel="noopener">
        <i class="fab fa-medium"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/matteo-courthoud-7335198a/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/MatteoCourthoud/" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/matteocourthoud" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://open.spotify.com/user/1180947523" target="_blank" rel="noopener">
        <i class="fab fa-spotify"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>
















  
  




        </div>
        </article>
    </main>
  </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  

  
  <p class="powered-by">
    
      <a href="/privacy/">Privacy Policy</a>
    
    
       &middot; 
      <a href="/terms/">Terms</a>
    
  </p>
  

  

  
  







</footer>

    </div>
    
  </div>

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js" integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin="anonymous"></script>

      
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.8.4/mermaid.min.js" integrity="sha512-as1BF4+iHZ3BVO6LLDQ7zrbvTXM+c/1iZ1qII/c3c4L8Rn5tHLpFUtpaEtBNS92f+xGsCzsD7b62XP3XYap6oA==" crossorigin="anonymous" title="mermaid"></script>
      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js" integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/python.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/julia.min.js"></script>
        
      

    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js" integrity="sha512-SeiQaaDh73yrb56sTW/RgVdi/mMqNeM2oBwubFHagc5BkixSpP1fvqF47mKzPGWYSSy4RwbBunrJBQ4Co8fRWA==" crossorigin="anonymous"></script>
    

    
    

    
    
    
      
      <script id="search-hit-fuse-template" type="text/x-template">
        <div class="search-hit" id="summary-{{key}}">
          <div class="search-hit-content">
            <div class="search-hit-name">
              <a href="{{relpermalink}}">{{title}}</a>
              <div class="article-metadata search-hit-type">{{type}}</div>
              <p class="search-hit-description">{{snippet}}</p>
            </div>
          </div>
        </div>
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
      
    

    
    

    
    
    
    

    
    <script src="/js/bootstrap.bundle.min.6aed84840afc03ab4d5750157f69c120.js"></script>

    
    
      
      
      
      
      
      
      
    

    
    
    
    
    
    
    
    
      
      
    
    
    <script src="/en/js/wowchemy.min.cf8ca859a9b74f8b1cd804621b13e5f1.js"></script>

    
  <script async defer src="https://buttons.github.io/buttons.js"></script>




</body>
</html>
