<!DOCTYPE html><html lang="en-us" >

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.1.0 for Hugo" />
  

  

  
  
  
  
  
    
    
    
  
  

  

  
  
  
    
  
  <meta name="description" content="In this tutorial, we are going to see how to estimate causal effects when we do not have access to a control group. These settings are extremely common in observational studies and, in these cases, claims of causality are relatively weak." />

  
  <link rel="alternate" hreflang="en-us" href="https://matteocourthoud.github.io/post/synthetic_control/" />

  







  




  
  
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    <meta name="theme-color" content="#003f5c" />
  

  
  
    
    <script src="/js/mathjax-config.js"></script>
  

  
  
  
  
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin="anonymous">

    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css" integrity="sha512-1xoFisiGdy9nvho8EgXuXvnpR5GAMSjFwp40gSRE3NwdUdIMIKuPa7bqoUhLD0O/5tPNhteAsE5XyyMi5reQVA==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Source+Sans+Pro:wght@200;300;400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Source+Sans+Pro:wght@200;300;400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.56a07b12facc5b7d5da5dd4bbdb82eef.css" />

  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-144780600-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'UA-144780600-1', { 'anonymize_ip': true });
  gtag('set', {'cookie_flags': 'SameSite=None;Secure'});

  
  document.addEventListener('click', onClickCallback, false);
</script>


  

  

  




  
  
  

  

  
    <link rel="manifest" href="/index.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu03e9b3967b83fd39296ec9da5ff1ea05_201175_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu03e9b3967b83fd39296ec9da5ff1ea05_201175_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://matteocourthoud.github.io/post/synthetic_control/" />

  
  
  
  
  
  
  
  
    
  
  
  <meta property="twitter:card" content="summary_large_image" />
  
  <meta property="og:site_name" content="Matteo Courthoud" />
  <meta property="og:url" content="https://matteocourthoud.github.io/post/synthetic_control/" />
  <meta property="og:title" content="Synthetic Control | Matteo Courthoud" />
  <meta property="og:description" content="In this tutorial, we are going to see how to estimate causal effects when we do not have access to a control group. These settings are extremely common in observational studies and, in these cases, claims of causality are relatively weak." /><meta property="og:image" content="https://matteocourthoud.github.io/post/synthetic_control/featured.png" />
    <meta property="twitter:image" content="https://matteocourthoud.github.io/post/synthetic_control/featured.png" /><meta property="og:locale" content="en-us" />
  
    
      <meta
        property="article:published_time"
        content="2022-04-09T00:00:00&#43;00:00"
      />
    
    <meta property="article:modified_time" content="2022-04-09T00:00:00&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://matteocourthoud.github.io/post/synthetic_control/"
  },
  "headline": "Synthetic Control",
  
  "image": [
    "https://matteocourthoud.github.io/post/synthetic_control/featured.png"
  ],
  
  "datePublished": "2022-04-09T00:00:00Z",
  "dateModified": "2022-04-09T00:00:00Z",
  
  "publisher": {
    "@type": "Organization",
    "name": "Matteo Courthoud",
    "logo": {
      "@type": "ImageObject",
      "url": "https://matteocourthoud.github.io/media/icon_hu03e9b3967b83fd39296ec9da5ff1ea05_201175_192x192_fill_lanczos_center_3.png"
    }
  },
  "description": "In this tutorial, we are going to see how to estimate causal effects when we do not have access to a control group. These settings are extremely common in observational studies and, in these cases, claims of causality are relatively weak."
}
</script>

  

  

  
  
  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.js" integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.css" integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin="anonymous">
  
  <script>
  window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#003f5c",
          "text": "rgb(255, 255, 255)"
        },
        "button": {
          "background": "rgb(255, 255, 255)",
          "text": "#003f5c"
        }
      },
      "theme": "classic",
      "content": {
        "message": "This website uses cookies to ensure you get the best experience on our website.",
        "dismiss": "Got it!",
        "link": "Learn more",
        "href": "/privacy/"
      }
    })});
  </script>


  





  <title>Synthetic Control | Matteo Courthoud</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="b5d7c5d08438854e3a113705c275ed8c" >

  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.6edaf3b475ce43de30d98828aea698be.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="Close"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="Search...">
        
      </div>

      
      

      

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    












<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container-xl">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">Matteo Courthoud</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">Matteo Courthoud</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-end" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#projects"><span>Research</span></a>
        </li>

        
        

        
        <li class="nav-item dropdown">
          <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>Courses</span><span class="caret"></span>
          </a>
          <div class="dropdown-menu">
            
              <a class="dropdown-item" href="/course/ml-econ/"><span>Machine Learning for Economics</span></a>
            
              <a class="dropdown-item" href="/course/data-science/"><span>Data Science with Python</span></a>
            
              <a class="dropdown-item" href="/course/empirical-io/"><span>Graduate Industrial Organization</span></a>
            
              <a class="dropdown-item" href="/course/metrics/"><span>Graduate Econometrics</span></a>
            
              <a class="dropdown-item" href="https://pp4rs.github.io/"><span>Programming Practices for Research</span></a>
            
          </div>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link  active" href="/post/"><span>Posts</span></a>
        </li>

        
        

        

        
        
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/cv"><span>CV</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

      
      
        
      

      
      

      
      

      
      

    </ul>

  </div>
</nav>


  </div>

  <div class="page-body">
    <div class="container-fluid docs">
  <div class="row">

    <div class="col-xl-2 col-lg-2 d-none d-xl-block d-lg-block empty">
    </div>

    <div class="col-2 col-xl-2 col-lg-2 d-none d-lg-block docs-toc">
      <ul class="nav toc-top">
        <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
      </ul>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#setting">Setting</a></li>
    <li><a href="#synthetic-control">Synthetic Control</a>
      <ul>
        <li><a href="#weights">Weights</a></li>
        <li><a href="#synthetic-control-vs-ols">Synthetic Control vs OLS</a></li>
      </ul>
    </li>
    <li><a href="#academic-application">Academic Application</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
    </div>

    <main class="col-xl-8 col-lg-8 docs-content" role="main">
        <article class="article">
        




















  


<div class="article-container pt-3">
  <h1>Synthetic Control</h1>

  

  


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    Apr 9, 2022
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    9 min read
  </span>
  

  
  
  
  
  
  

  
  

</div>

  





</div>


<div class="article-header article-container featured-image-wrapper mt-4 mb-4" style="max-width: 1192px; max-height: 817px;">
  <div style="position: relative">
    <img src="/post/synthetic_control/featured.png" alt="" class="featured-image">
    
  </div>
</div>


        <div class="article-container">
          <div class="article-style" align="justify">
            <p>In this tutorial, we are going to see how to estimate causal effects when we do not have access to a control group. These settings are extremely common in observational studies and, in these cases, claims of causality are relatively weak. However, there still exist methods to make causal claims, under certain assumptions.</p>
<p><strong>Requisites</strong></p>
<p>For this tutorial, I assume you are familiar with the following concepts:</p>
<ul>
<li>Rubin&rsquo;s potential outcome framework</li>
<li>Ordinary least squares regression</li>
<li><a href="https://matteocourthoud.github.io/post/permutation_test/" target="_blank" rel="noopener">Randomization/permutation inference</a></li>
</ul>
<p><strong>Academic Application</strong></p>
<p>As an academic application, we are going to replicate <a href="https://www.tandfonline.com/doi/abs/10.1198/jasa.2009.ap08746" target="_blank" rel="noopener">Synthetic Control Methods for Comparative Case Studies: Estimating the Effect of California’s Tobacco Control Program</a> (2010) by Abadie, Diamond and Hainmueller. The authors study the effect of a tobacco control program in California onsmoking habits.</p>
<p><strong>Business Case</strong></p>
<p>TBD</p>
<h2 id="setting">Setting</h2>
<p>We assume that for a panel of i.i.d. subjects $i = 1, &hellip;, n$ over time $t=1, &hellip;,$ we observed a tuple $(X_{i,t}, Y_{i,t})$ comprised of</p>
<ul>
<li>a feature vector $X_{i,t} \in \mathbb R^p$</li>
<li>a response $Y_{i,t} \in \mathbb R$</li>
</ul>
<p>Moreover, one unit is treated at time $\tau$. We distinguish time periods in pre-treatment periods and post-treatment periods.</p>
<p>Crucially, treatment is not randomly assignment, therefore a difference in means between the treated unit and the control group is not an unbiased estimator of the average treatment effect.</p>
<h2 id="synthetic-control">Synthetic Control</h2>
<p>The problem is that, as usual, we do not observe the counterfactual outcome for treated units, i.e. we do not know what would have happened to them, if they had not been treated. This is known as the <strong>fundamental problem of causal inference</strong>.</p>
<p>The simplest approach, would be just to compare pre and post periods. This is called the <strong>event study</strong> approach.</p>
<p>However, we can do better than this. In fact, even though treatment was not randomly assigned, we still have access to some units that were not treated.</p>
<p>For the outcome variable we have the following setup</p>
<p>$$
Y =
\begin{bmatrix}
Y_{t, post} \ &amp; Y_{c, post} \newline
Y_{t, pre} \ &amp; Y_{c, pre}
\end{bmatrix}
$$</p>
<p>which we can rewrite as</p>
<p>$$
Y =
\begin{bmatrix}
Y^{(1)} _ {t, post} \ &amp; Y^{(0)} _ {c, post} \newline
Y^{(0)} _ {t, pre} \ &amp; Y^{(0)} _ {c, pre}
\end{bmatrix}
$$</p>
<p>We basically have a <strong>missing data problem</strong> since we do not observe $Y^{(0)} _ {t, post}$.</p>
<p>Following Doudchenko and Inbens (2018), we can formulate an estimate of the counterfactual outcome for the treated unit as a linear combination of the observed outcomes for the control units.</p>
<p>$$
\hat Y^{(0)} _ {t, post} = \alpha + \sum_{i \in c} \beta_{i} Y^{(0)} _ {i, post}
$$</p>
<p>where</p>
<ul>
<li>the constant $\alpha$ allows for different averages between the two groups</li>
<li>the weights $\beta_i$ are allowed to vary across control units $i$
<ul>
<li>otherwise it would be a diff-in-diff</li>
</ul>
</li>
</ul>
<h3 id="weights">Weights</h3>
<p>How should we choose which weights to use? One <strong>option</strong> could be to simply run a linear regression of the pre-treatment outcome of the treatment unit $Y^{(0)} _ {t, pre}$ on the pre-treatment outcome of the control group $Y^{(0)} _ {c, pre}$.</p>
<p>There are two problems with this approach:</p>
<ol>
<li>
<p>the weights might be negative</p>
<ul>
<li>how should we interpret them?</li>
<li>they make no sense in the potential outcome framework</li>
</ul>
</li>
<li>
<p>weights could be greater or lower than one</p>
<ul>
<li>therefore we would not be able to interpret the synthetic control as a weighted average of untreated units</li>
</ul>
</li>
</ol>
<p>To solve this problem, Abadie et al (2010) propose the following weights:</p>
<p>$$
\hat \beta = \arg \min_{\beta} || \boldsymbol X_t - \boldsymbol \beta \boldsymbol X_c || = \sqrt{ \sum_{p} \left( X_{t, p}  - \sum_{i \in c} \beta_{p} X_{c, p} \right)^2 }
\quad \text{s.t.} \quad \sum_{p} \beta_p = 1 \quad \text{and} \quad \beta_p \geq 0 \ \forall p
$$</p>
<p>With this approach we get an interpretable counterfactual.</p>
<h3 id="synthetic-control-vs-ols">Synthetic Control vs OLS</h3>
<p>What are the advantages and disadvantages of synthetic control methods with respect to a simple regression?</p>
<ol>
<li>
<p>As long as we use positive weights that are constrained to sum to one, the method avoid extrapolation</p>
<ul>
<li>we will never go out of the support of the data</li>
</ul>
</li>
<li>
<p>It can be &ldquo;pre-registered&rdquo; in the sense that you don&rsquo;t need post-treatment observations to build the method</p>
<ul>
<li>could avoid p-hacking and cherry picking</li>
</ul>
</li>
<li>
<p>Weights make explicit the counterfactual analysis</p>
<ul>
<li>one can look at the weights and understand which comparison we are making</li>
</ul>
</li>
<li>
<p>It&rsquo;s a bridge between quantitative and qualitative research</p>
<ul>
<li>can be used to inspect single-treated unit cases</li>
</ul>
</li>
</ol>
<h2 id="academic-application">Academic Application</h2>
<p>As an academic application, we are going to replicate <a href="https://www.tandfonline.com/doi/abs/10.1198/jasa.2009.ap08746" target="_blank" rel="noopener">Synthetic Control Methods for Comparative Case Studies: Estimating the Effect of California’s Tobacco Control Program</a> (2010) by Abadie, Diamond and Hainmueller. The authors study the effect of a tobacco control program in California on smoking habits.</p>
<p>In particular, in 1989, California passes a tobacco control program that significantly reduces the sales of cigarettes. Was this program effective? Unfortunately, there is neither a counterfactual scenario, nor a randomized experiment.</p>
<p>Let&rsquo;s start by loading the data.</p>
<pre><code class="language-python">%matplotlib inline
%config InlineBackend.figure_format = 'retina'
</code></pre>
<pre><code class="language-python">from src.utils import *
</code></pre>
<pre><code class="language-python">df = pd.read_csv('data/adh10.csv')
df.head()
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>state</th>
      <th>year</th>
      <th>cig_sales</th>
      <th>lnincome</th>
      <th>beer</th>
      <th>age15to24</th>
      <th>retprice</th>
      <th>california</th>
      <th>after_treatment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1970</td>
      <td>89.800003</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.178862</td>
      <td>39.599998</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1971</td>
      <td>95.400002</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.179928</td>
      <td>42.700001</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>1972</td>
      <td>101.099998</td>
      <td>9.498476</td>
      <td>NaN</td>
      <td>0.180994</td>
      <td>42.299999</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>1973</td>
      <td>102.900002</td>
      <td>9.550107</td>
      <td>NaN</td>
      <td>0.182060</td>
      <td>42.099998</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>1974</td>
      <td>108.199997</td>
      <td>9.537163</td>
      <td>NaN</td>
      <td>0.183126</td>
      <td>43.099998</td>
      <td>False</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div>
<p>We have information on cigarette costs, sales, tax rate and revenues for all US states for years from 1970 to 2014.</p>
<pre><code class="language-python">from causalml.match import create_table_one

create_table_one(df, 'california', ['cig_sales', 'lnincome', 'beer', 'age15to24', 'retprice'])
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Control</th>
      <th>Treatment</th>
      <th>SMD</th>
    </tr>
    <tr>
      <th>Variable</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>n</th>
      <td>1178</td>
      <td>31</td>
      <td></td>
    </tr>
    <tr>
      <th>age15to24</th>
      <td>0.18 (0.02)</td>
      <td>0.18 (0.01)</td>
      <td>0.0454</td>
    </tr>
    <tr>
      <th>beer</th>
      <td>23.46 (4.26)</td>
      <td>22.26 (2.11)</td>
      <td>-0.3559</td>
    </tr>
    <tr>
      <th>cig_sales</th>
      <td>119.53 (32.60)</td>
      <td>94.59 (30.01)</td>
      <td>-0.7962</td>
    </tr>
    <tr>
      <th>lnincome</th>
      <td>9.86 (0.17)</td>
      <td>10.07 (0.08)</td>
      <td>1.6107</td>
    </tr>
    <tr>
      <th>retprice</th>
      <td>108.04 (64.00)</td>
      <td>119.92 (77.90)</td>
      <td>0.1667</td>
    </tr>
  </tbody>
</table>
</div>
<p>We are interested in the sales of cigarettes <code>cig_sales</code> over time. Let&rsquo;s start by reshaping the dataset so that each state is a time series.</p>
<pre><code class="language-python">df = df.pivot(index='year', columns='state', values='cig_sales').reset_index()
df.head()
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>state</th>
      <th>year</th>
      <th>1</th>
      <th>10</th>
      <th>11</th>
      <th>12</th>
      <th>13</th>
      <th>14</th>
      <th>15</th>
      <th>16</th>
      <th>17</th>
      <th>...</th>
      <th>37</th>
      <th>38</th>
      <th>39</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>California</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1970</td>
      <td>89.800003</td>
      <td>134.600006</td>
      <td>108.500000</td>
      <td>114.000000</td>
      <td>155.800003</td>
      <td>115.900002</td>
      <td>128.500000</td>
      <td>104.300003</td>
      <td>93.400002</td>
      <td>...</td>
      <td>114.500000</td>
      <td>106.400002</td>
      <td>132.199997</td>
      <td>124.800003</td>
      <td>120.000000</td>
      <td>155.000000</td>
      <td>109.900002</td>
      <td>102.400002</td>
      <td>124.800003</td>
      <td>123.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1971</td>
      <td>95.400002</td>
      <td>139.300003</td>
      <td>108.400002</td>
      <td>102.800003</td>
      <td>163.500000</td>
      <td>119.800003</td>
      <td>133.199997</td>
      <td>116.400002</td>
      <td>105.400002</td>
      <td>...</td>
      <td>111.500000</td>
      <td>105.400002</td>
      <td>131.699997</td>
      <td>125.500000</td>
      <td>117.599998</td>
      <td>161.100006</td>
      <td>115.699997</td>
      <td>108.500000</td>
      <td>125.599998</td>
      <td>121.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1972</td>
      <td>101.099998</td>
      <td>149.199997</td>
      <td>109.400002</td>
      <td>111.000000</td>
      <td>179.399994</td>
      <td>125.300003</td>
      <td>136.500000</td>
      <td>96.800003</td>
      <td>112.099998</td>
      <td>...</td>
      <td>117.500000</td>
      <td>108.800003</td>
      <td>140.000000</td>
      <td>134.300003</td>
      <td>110.800003</td>
      <td>156.300003</td>
      <td>117.000000</td>
      <td>126.099998</td>
      <td>126.599998</td>
      <td>123.500000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1973</td>
      <td>102.900002</td>
      <td>156.000000</td>
      <td>110.599998</td>
      <td>115.199997</td>
      <td>201.899994</td>
      <td>126.699997</td>
      <td>138.000000</td>
      <td>106.800003</td>
      <td>115.000000</td>
      <td>...</td>
      <td>116.599998</td>
      <td>109.500000</td>
      <td>141.199997</td>
      <td>137.899994</td>
      <td>109.300003</td>
      <td>154.699997</td>
      <td>119.800003</td>
      <td>121.800003</td>
      <td>124.400002</td>
      <td>124.400002</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1974</td>
      <td>108.199997</td>
      <td>159.600006</td>
      <td>116.099998</td>
      <td>118.599998</td>
      <td>212.399994</td>
      <td>129.899994</td>
      <td>142.100006</td>
      <td>110.599998</td>
      <td>117.099998</td>
      <td>...</td>
      <td>119.900002</td>
      <td>111.800003</td>
      <td>145.800003</td>
      <td>132.800003</td>
      <td>112.400002</td>
      <td>151.300003</td>
      <td>123.699997</td>
      <td>125.599998</td>
      <td>131.899994</td>
      <td>126.699997</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 40 columns</p>
</div>
<p>In an ideal world, one could use the average of all the other states in the United States as a control. Let&rsquo;s plot what that would look like.</p>
<pre><code class="language-python">states = [c for c in df.columns if c not in ['year']]
df['Other States'] = df[[s for s in states if s != 'California']].mean(axis=1)
</code></pre>
<pre><code class="language-python">def plot_lines(df, line1, line2, hline=True):
    sns.lineplot(x=df['year'], y=df[line1].values, label=line1)
    sns.lineplot(x=df['year'], y=df[line2].values, label=line2)
    plt.axvline(x=1988, ls=&quot;:&quot;, color='C2', label='Proposition 99', zorder=1)
    plt.legend();
    plt.title(&quot;Per-capita cigarette sales (in packs)&quot;);
</code></pre>
<pre><code class="language-python">plot_lines(df, 'California', 'Other States')
</code></pre>
<p><img src="img/synthetic_control_22_0.png" alt="png"></p>
<p>It looks like the trends are slightly diverging after 1989, the year of Proposition 99. However, it also looks like the trends are sensibly different before 1989. Therefore, it feels quite a stretch to attribute the differences in cigarette sales post 1989 to Proposition 99 alone.</p>
<p>The idea is to <strong>build a synthetic control</strong> state for California. Maybe no single state is a good control, but a combination of them could actually provide a good approximation to California. Intuitively, one could think that better approximations are states that are</p>
<ul>
<li>larger</li>
<li>more democratic</li>
</ul>
<p>In practice, we are going to try to build the synthetic control state such as it approximates pre-trend, the sales of cigarettes pre 1989. Let&rsquo;s start by using <code>LinearRegression</code>.</p>
<pre><code class="language-python">from sklearn.linear_model import LinearRegression

def synth_predict(df, state, model):
    y = df.loc[df['year'] &lt;= 1988, state]
    other_states = [c for c in states if c not in ['year', state]]
    X = df.loc[df['year'] &lt;= 1988, other_states]
    df[f'Synthetic {state}'] = model.fit(X, y).predict(df[other_states])
    return model.coef_
</code></pre>
<pre><code class="language-python">coef = synth_predict(df, 'California', LinearRegression())
</code></pre>
<p>Let&rsquo;s now plot the predicted against the actual time series.</p>
<pre><code class="language-python">plot_lines(df, 'California', 'Synthetic California')
</code></pre>
<p><img src="img/synthetic_control_27_0.png" alt="png"></p>
<p>It looks like the policy had a sensible <strong>negative effect</strong> on cigarette sales.</p>
<p>We can also observe that we are clearly <strong>overfitting</strong>: the pre-policy predicted cigarette consumption line is exactly flat. One way to avoid overfitting is to use a penalized estimator.</p>
<p>Another problem concerns the <strong>weights</strong>. We have not set any constraint on the weights. Let&rsquo;s see what they look like.</p>
<pre><code class="language-python">sns.histplot(coef, bins=30).set(title='Coefficients');
</code></pre>
<p><img src="img/synthetic_control_30_0.png" alt="png"></p>
<p>We have many <strong>negative weights</strong>, which do not make much sense from a causal inference perspective. In principle all weights should be between zero and one.</p>
<p>To address both concerns, we are going to build a new estimator called <code>SyntheticControl()</code> which constrains weights to sum to 1 and to be positive.</p>
<pre><code class="language-python">from typing import List
from operator import add
from toolz import reduce, partial
from scipy.optimize import fmin_slsqp

class SyntheticControl():
    
    # Loss function
    def loss(self, W, X, y) -&gt; float:
        return np.sqrt(np.mean((y - X.dot(W))**2))

    # Fit model
    def fit(self, X, y):
        w_start = [1/X.shape[1]]*X.shape[1]
        self.coef_ = fmin_slsqp(partial(self.loss, X=X, y=y),
                         np.array(w_start),
                         f_eqcons=lambda x: np.sum(x) - 1,
                         bounds=[(0.0, 1.0)]*len(w_start),
                         disp=False)
        return self
    
    # Predict 
    def predict(self, X):
        return X.dot(self.coef_)
</code></pre>
<pre><code class="language-python">synth_predict(df, 'California', SyntheticControl())
plot_lines(df, 'California', 'Synthetic California')
</code></pre>
<p><img src="img/synthetic_control_33_0.png" alt="png"></p>
<p>Let&rsquo;s plot the <strong>difference</strong> between the two lines to better visualize the magnitude of the effect.</p>
<pre><code class="language-python">def plot_difference(df, state, vline=True, hline=True, **kwargs):
    sns.lineplot(x=df['year'], y=df[state] - df[f'Synthetic {state}'], **kwargs)
    if vline: 
        plt.axvline(x=1988, ls=&quot;:&quot;, color='C2', label='Proposition 99', zorder=1)
        plt.legend()
    if hline: sns.lineplot(x=df['year'], y=0, lw=1, color='black', zorder=1)
    plt.title(&quot;Normalized per-capita cigarette sales (in packs)&quot;);
</code></pre>
<pre><code class="language-python">plot_difference(df, 'California', label='California')
</code></pre>
<p><img src="img/synthetic_control_36_0.png" alt="png"></p>
<p>The normalized estimator gives a very similar prediction, however it does not blatantly overfit the pre-period.</p>
<p>Is the estimate significant? The question we are trying to answer is &ldquo;<em>how unusual is this estimate under the null hypothesis of no policy effect</em>?&rdquo;. We are going to perform a randomization/permutation test in order to answer this question. The <strong>idea</strong> is that if the policy has no effect, the effect we observe for California should not be significantly different from the effect we observe for any other state.</p>
<p>Therefore, we are going to replicate the procedure above, but for all other states and observe how unusual is California.</p>
<pre><code class="language-python">for state in states:
    synth_predict(df, state, SyntheticControl())
    plot_difference(df, state, vline=False, alpha=0.2, color='grey')
plot_difference(df, 'California', label='California')
</code></pre>
<p><img src="img/synthetic_control_38_0.png" alt="png"></p>
<p>It looks like the effect for California is quite extreme, especially if we consider a one-sided hypothesis test (it feels weird to assume that the policy could ever increase cigarette sales). We get more extreme only for a couple of states, especially in the first 10 years. Therefore, we conclude that the effect of the Proposition 99 policy is statistically different from zero.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=BsRqy7juMus" target="_blank" rel="noopener">Synthetic Control</a> video lecture by Paul Goldsmith-Pinkham (Yale)</li>
<li><a href="https://mixtape.scunning.com/synthetic-control.html" target="_blank" rel="noopener">Synthetic Control</a> chapter of the Causal Inference Mixtape by Scott Cunningham</li>
</ul>

          </div>
          








<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://matteocourthoud.github.io/post/synthetic_control/&amp;text=Synthetic%20Control" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://matteocourthoud.github.io/post/synthetic_control/&amp;t=Synthetic%20Control" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Synthetic%20Control&amp;body=https://matteocourthoud.github.io/post/synthetic_control/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://matteocourthoud.github.io/post/synthetic_control/&amp;title=Synthetic%20Control" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=Synthetic%20Control%20https://matteocourthoud.github.io/post/synthetic_control/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://t.me/share/url?url=https://matteocourthoud.github.io/post/synthetic_control/&amp;text=%7btext%7d" target="_blank" rel="noopener" class="share-btn-telegram">
          <i class="fab fa-telegram"></i>
        </a>
      </li>
    
  </ul>
</div>











  
  



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="https://matteocourthoud.github.io/"><img class="avatar mr-3 avatar-circle" src="/author/avatar_hu365eedc833ccd5578a90de7c849ec45e_385094_270x270_fill_q75_lanczos_center.jpg" alt=""></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://matteocourthoud.github.io/"></a></h5>
      
      <p class="card-text">My research fields are empirical Industrial Organization and Competition Policy. My research interests include the relationship between competition and innovation, big data, artificial intelligence, platform markets, peer to peer services.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.econ.uzh.ch/en/people/graduatestudents/courthoud.html" target="_blank" rel="noopener">
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/matteo-courthoud-7335198a/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/MatteoCourthoud/" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/matteocourthoud" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://open.spotify.com/user/1180947523" target="_blank" rel="noopener">
        <i class="fab fa-spotify"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>
















  
  




        </div>
        </article>
    </main>
  </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  

  
  <p class="powered-by">
    
      <a href="/privacy/">Privacy Policy</a>
    
    
       &middot; 
      <a href="/terms/">Terms</a>
    
  </p>
  

  
  <p class="powered-by">
    Theme edited by Matteo Courthoud© - Want to have a similar website? <a href="https://matteocourthoud.github.io/post/website/">Guide here</a>.
  </p>
  

  
  







</footer>

    </div>
    
  </div>

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js" integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin="anonymous"></script>

      
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.8.4/mermaid.min.js" integrity="sha512-as1BF4+iHZ3BVO6LLDQ7zrbvTXM+c/1iZ1qII/c3c4L8Rn5tHLpFUtpaEtBNS92f+xGsCzsD7b62XP3XYap6oA==" crossorigin="anonymous" title="mermaid"></script>
      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js" integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/python.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/julia.min.js"></script>
        
      

    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js" integrity="sha512-SeiQaaDh73yrb56sTW/RgVdi/mMqNeM2oBwubFHagc5BkixSpP1fvqF47mKzPGWYSSy4RwbBunrJBQ4Co8fRWA==" crossorigin="anonymous"></script>
    

    
    

    
    
    
      
      <script id="search-hit-fuse-template" type="text/x-template">
        <div class="search-hit" id="summary-{{key}}">
          <div class="search-hit-content">
            <div class="search-hit-name">
              <a href="{{relpermalink}}">{{title}}</a>
              <div class="article-metadata search-hit-type">{{type}}</div>
              <p class="search-hit-description">{{snippet}}</p>
            </div>
          </div>
        </div>
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
      
    

    
    

    
    
    
    

    
    <script src="/js/bootstrap.bundle.min.6aed84840afc03ab4d5750157f69c120.js"></script>

    
    
      
      
      
      
      
      
      
    

    
    
    
    
    
    
    
    
      
      
    
    
    <script src="/en/js/wowchemy.min.cf8ca859a9b74f8b1cd804621b13e5f1.js"></script>

    
  <script async defer src="https://buttons.github.io/buttons.js"></script>




</body>
</html>
