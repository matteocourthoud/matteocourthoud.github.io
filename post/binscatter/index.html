<!DOCTYPE html><html lang="en-us" >

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.1.0 for Hugo" />
  

  

  
  
  
  
  
    
    
    
  
  

  

  
  
  
    
  
  <meta name="description" content="When we want to visualize the relationship between two continuous variables, the go-to plot is the scatterplot. It&rsquo;s a very intuitive visualization tool that allows us to directly look at the data." />

  
  <link rel="alternate" hreflang="en-us" href="https://matteocourthoud.github.io/post/binscatter/" />

  







  




  
  
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    <meta name="theme-color" content="#003f5c" />
  

  
  
    
    <script src="/js/mathjax-config.js"></script>
  

  
  
  
  
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin="anonymous">

    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css" integrity="sha512-1xoFisiGdy9nvho8EgXuXvnpR5GAMSjFwp40gSRE3NwdUdIMIKuPa7bqoUhLD0O/5tPNhteAsE5XyyMi5reQVA==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Source+Sans+Pro:wght@200;300;400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Source+Sans+Pro:wght@200;300;400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.4f7182ca394d705ee32d9d7750e9aa1d.css" />

  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-144780600-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'UA-144780600-1', { 'anonymize_ip': true });
  gtag('set', {'cookie_flags': 'SameSite=None;Secure'});

  
  document.addEventListener('click', onClickCallback, false);
</script>


  

  

  




  
  
  

  

  
    <link rel="manifest" href="/index.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu03e9b3967b83fd39296ec9da5ff1ea05_201175_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu03e9b3967b83fd39296ec9da5ff1ea05_201175_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://matteocourthoud.github.io/post/binscatter/" />

  
  
  
  
  
  
  
  
    
  
  
  <meta property="twitter:card" content="summary_large_image" />
  
  <meta property="og:site_name" content="Matteo Courthoud" />
  <meta property="og:url" content="https://matteocourthoud.github.io/post/binscatter/" />
  <meta property="og:title" content="Goodbye Scatterplot, Welcome Binned Scatterplot | Matteo Courthoud" />
  <meta property="og:description" content="When we want to visualize the relationship between two continuous variables, the go-to plot is the scatterplot. It&rsquo;s a very intuitive visualization tool that allows us to directly look at the data." /><meta property="og:image" content="https://matteocourthoud.github.io/post/binscatter/featured.png" />
    <meta property="twitter:image" content="https://matteocourthoud.github.io/post/binscatter/featured.png" /><meta property="og:locale" content="en-us" />
  
    
      <meta
        property="article:published_time"
        content="2022-05-21T00:00:00&#43;00:00"
      />
    
    <meta property="article:modified_time" content="2022-05-21T00:00:00&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://matteocourthoud.github.io/post/binscatter/"
  },
  "headline": "Goodbye Scatterplot, Welcome Binned Scatterplot",
  
  "image": [
    "https://matteocourthoud.github.io/post/binscatter/featured.png"
  ],
  
  "datePublished": "2022-05-21T00:00:00Z",
  "dateModified": "2022-05-21T00:00:00Z",
  
  "publisher": {
    "@type": "Organization",
    "name": "Matteo Courthoud",
    "logo": {
      "@type": "ImageObject",
      "url": "https://matteocourthoud.github.io/media/icon_hu03e9b3967b83fd39296ec9da5ff1ea05_201175_192x192_fill_lanczos_center_3.png"
    }
  },
  "description": "When we want to visualize the relationship between two continuous variables, the go-to plot is the scatterplot. It\u0026rsquo;s a very intuitive visualization tool that allows us to directly look at the data."
}
</script>

  

  

  
  
  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.js" integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.css" integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin="anonymous">
  
  <script>
  window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#003f5c",
          "text": "rgb(255, 255, 255)"
        },
        "button": {
          "background": "rgb(255, 255, 255)",
          "text": "#003f5c"
        }
      },
      "theme": "classic",
      "content": {
        "message": "This website uses cookies to ensure you get the best experience on our website.",
        "dismiss": "Got it!",
        "link": "Learn more",
        "href": "/privacy/"
      }
    })});
  </script>


  





  <title>Goodbye Scatterplot, Welcome Binned Scatterplot | Matteo Courthoud</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="85b043e318961b36996123d1a50b9534" >

  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.66d3e0fff6d32c4ece05adee927fbd96.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="Close"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="Search...">
        
      </div>

      
      

      

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    












<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container-xl">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">Matteo Courthoud</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">Matteo Courthoud</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-end" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#projects"><span>Research</span></a>
        </li>

        
        

        
        <li class="nav-item dropdown">
          <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>Courses</span><span class="caret"></span>
          </a>
          <div class="dropdown-menu">
            
              <a class="dropdown-item" href="/course/ml-econ/"><span>Machine Learning for Economics</span></a>
            
              <a class="dropdown-item" href="/course/data-science/"><span>Data Science with Python</span></a>
            
              <a class="dropdown-item" href="/course/empirical-io/"><span>PhD Industrial Organization</span></a>
            
              <a class="dropdown-item" href="/course/metrics/"><span>PhD Econometrics</span></a>
            
              <a class="dropdown-item" href="https://pp4rs.github.io/"><span>Programming Practices for Research</span></a>
            
          </div>
        </li>

        
        

        

        
        
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/cv"><span>CV</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

      
      
        
      

      
      

      
      

      
      

    </ul>

  </div>
</nav>


  </div>

  <div class="page-body">
    <div class="container-fluid docs">
  <div class="row">

    <div class="col-xl-2 col-lg-2 d-none d-xl-block d-lg-block empty">
    </div>

    <div class="col-2 col-xl-2 col-lg-2 d-none d-lg-block docs-toc">
      <ul class="nav toc-top">
        <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
      </ul>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#the-scatterplot">The Scatterplot</a></li>
    <li><a href="#scatterplot-alternatives">Scatterplot Alternatives</a></li>
    <li><a href="#the-binned-scatterplot">The Binned Scatterplot</a>
      <ul>
        <li><a href="#details">Details</a></li>
        <li><a href="#binsreg">Binsreg</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
    </div>

    <main class="col-xl-8 col-lg-8 docs-content" role="main">
        <article class="article">
        




















  


<div class="article-container pt-3">
  <h1>Goodbye Scatterplot, Welcome Binned Scatterplot</h1>

  

  


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    May 21, 2022
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    10 min read
  </span>
  

  
  
  
  
  
  

  
  

</div>

  





</div>


<div class="article-header article-container featured-image-wrapper mt-4 mb-4" style="max-width: 1143px; max-height: 634px;">
  <div style="position: relative">
    <img src="/post/binscatter/featured.png" alt="" class="featured-image">
    
  </div>
</div>


        <div class="article-container">
          <div class="article-style" align="justify">
            <p>When we want to visualize the relationship between two continuous variables, the go-to plot is the <strong>scatterplot</strong>. It&rsquo;s a very intuitive visualization tool that allows us to directly look at the data. However, when we have a lot of data and/or when the data is skewed, scatterplots can be too noisy to be informative.</p>
<p>In this blog post, I am going to review a very powerful alternative to the scatterplot to visualize correlations between two variables: the <strong>binned scatterplot</strong>. Binned scatterplots are not only a great visualization tool, but they can also be used to do inference on the conditional distribution of the dependent variable.</p>
<h2 id="the-scatterplot">The Scatterplot</h2>
<p>Let&rsquo;s start with an example. Suppose we are an <strong>online marketplace</strong> where multiple firms offer goods that consumer can efficiently browse, compare and buy. Our <strong>dataset</strong> consists in a snapshot of the firms active on the marketplace.</p>
<p>Let&rsquo;s load the data and have a look at it. You can find the code for the data generating process <a href="">here</a>.</p>
<pre><code class="language-python">%matplotlib inline
%config InlineBackend.figure_format = 'retina'
</code></pre>
<pre><code class="language-python">from src.utils import *
from src.dgp import dgp_marketplace

df = dgp_marketplace().generate_data(N=10_000)
df.head()
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>sales</th>
      <th>online</th>
      <th>products</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.312777</td>
      <td>450.858091</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.176221</td>
      <td>1121.882449</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.764048</td>
      <td>2698.714549</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.082742</td>
      <td>1627.746386</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3.156503</td>
      <td>1464.593939</td>
      <td>0</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>
<p>We have information on 10.000 firms. For each firm we know:</p>
<ul>
<li><code>age</code>: the age of the firm</li>
<li><code>sales</code>: the monthly sales from last month</li>
<li><code>online</code>: whether the firm is only active online</li>
<li><code>products</code>: the number of products that the firm offers</li>
</ul>
<p>Suppose we are interested in understanding the relationship between <code>age</code> and <code>sales</code>. What is the <strong>life-cycle</strong> of sales?</p>
<p>Let&rsquo;s start with a simple <strong>scatterplot</strong> of <code>sales</code> over <code>age</code>.</p>
<pre><code class="language-python">sns.scatterplot(x='age', y='sales', data=df);
plt.title(&quot;Sales by firm's age&quot;);
</code></pre>
<p><img src="img/binscatter_7_0.png" alt="png"></p>
<p>The plot is extremely <strong>noisy</strong>. We have a lot of observations, therefore, it is very difficult to visualize them all. If we had to guess, we could say that the relationship looks negative (<code>sales</code> decrease with <code>age</code>), but it would be a very uninformed guess.</p>
<p>We are now going to explore some plausible tweaks and alternatives.</p>
<h2 id="scatterplot-alternatives">Scatterplot Alternatives</h2>
<p>What can we do when we have an extremely dense scatterplot? One solution could be to plot the <strong>density</strong> of the observations, instead of the observations themselves.</p>
<p>There are multiple solutions in Python to visualize the density of a 2-dimensional distribution. A very useful one is <a href="https://seaborn.pydata.org/" target="_blank" rel="noopener">seaborn</a> <a href="https://seaborn.pydata.org/generated/seaborn.jointplot.html" target="_blank" rel="noopener">jointplot</a>. <code>jointplot</code> plots the joint distribution of two variables, together with the marginal distributions along the axis. The default option is the scatterplot, but one can also choose to add a regression line (<code>reg</code>), change the plot to a histogram (<code>hist</code>), a hexplot (<code>hex</code>), or a <a href="https://en.wikipedia.org/wiki/Kernel_density_estimation" target="_blank" rel="noopener">kernel density estimate</a> (<code>kde</code>).</p>
<p>Let&rsquo;s try the <strong>hexplot</strong>, which is basically a histogram of the data, where the bins are hexagons, in the 2-dimensional space.</p>
<pre><code class="language-python">s = sns.jointplot(x='age', y='sales', data=df, kind='hex', );
s.ax_joint.grid(False);
s.ax_marg_y.grid(False);
s.fig.suptitle(&quot;Sales by firm's age&quot;);
</code></pre>
<p><img src="img/binscatter_11_0.png" alt="png"></p>
<p>Not much has changed. It looks like the distributions of <code>age</code> and <code>sales</code> are both very <strong>skewed</strong> and, therefore, most of the action is concentrated in a very small subspace.</p>
<p>Maybe we could remove <strong>outliers</strong> and zoom-in on the area where most of the data is located. Let&rsquo;s zoom-in on the bottom-left corner, on observations what have <code>age &lt; 3</code> and <code>sales &lt; 3000</code>.</p>
<pre><code class="language-python">s = sns.jointplot(x='age', y='sales', data=df.query(&quot;age &lt; 3 &amp; sales &lt; 3000&quot;), kind=&quot;hex&quot;);
s.ax_joint.grid(False);
s.ax_marg_y.grid(False);
s.fig.suptitle(&quot;Sales by firm's age&quot;);
</code></pre>
<p><img src="img/binscatter_13_0.png" alt="png"></p>
<p>Now there is much less empty space, but it does not look like we are going far. The joint distribution is <strong>still too skewed</strong>. This is the case when the data follows some power distribution, as it&rsquo;s often the case with business data.</p>
<p>One solution is to <strong>transform</strong> the variable, by taking the <a href="https://en.wikipedia.org/wiki/Natural_logarithm" target="_blank" rel="noopener"><strong>natural logarithm</strong></a>.</p>
<pre><code class="language-python">df['log_age'] = np.log(df['age'])
df['log_sales'] = np.log(df['sales'])
</code></pre>
<p>We can now plot the relationship between the logarithms of <code>age</code> and <code>sales</code>.</p>
<pre><code class="language-python">s = sns.jointplot(x='log_age', y='log_sales', data=df, kind='hex');
s.ax_joint.grid(False);
s.ax_marg_y.grid(False);
s.fig.suptitle(&quot;Sales by firm's age&quot;, y=1.02);
</code></pre>
<p><img src="img/binscatter_17_0.png" alt="png"></p>
<p>The logarithm definitely helped. Now the data is more spread across space, which means that the visualization is more informative. Moreover, it looks like there is <strong>no relationship</strong> between the two variables.</p>
<p>However, there is still <strong>too much noise</strong>. Maybe data visualization alone is not sufficient do draw a conclusion.</p>
<p>Let&rsquo;s swap to a more structured approach: <a href="https://en.wikipedia.org/wiki/Linear_regression" target="_blank" rel="noopener"><strong>linear regression</strong></a>. Let&rsquo;s linearly regress <code>log_sales</code> on <code>log_age</code>.</p>
<pre><code class="language-python">smf.ols('log_sales ~ log_age', df).fit().summary().tables[1]
</code></pre>
<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td>    7.3971</td> <td>    0.015</td> <td>  478.948</td> <td> 0.000</td> <td>    7.367</td> <td>    7.427</td>
</tr>
<tr>
  <th>log_age</th>   <td>    0.1690</td> <td>    0.010</td> <td>   16.888</td> <td> 0.000</td> <td>    0.149</td> <td>    0.189</td>
</tr>
</table>
<p>The regression coefficient for <code>log_age</code> is <strong>positive</strong> and statistically significant (i.e. different from zero). It seems that all previous visualizations were very <strong>misleading</strong>. From none of the graphs above we could have guessed such a strong positive relationship.</p>
<p>However, maybe this relationship is different for <code>online</code>-only firms and the rest of the sample. We need to control for this variable in order to avoid <a href="https://en.wikipedia.org/wiki/Simpson%27s_paradox" target="_blank" rel="noopener">Simpson&rsquo;s Paradox</a> and, more generally, bias.</p>
<p>With linear regression, we can <strong>condition the analysis on covariates</strong>. Let&rsquo;s add the binary indicator for <code>online</code>-only firms and the variable counting the number of <code>products</code> to the regression.</p>
<pre><code class="language-python">smf.ols('log_sales ~ log_age + online + products', df).fit().summary().tables[1]
</code></pre>
<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td>    6.5717</td> <td>    0.037</td> <td>  176.893</td> <td> 0.000</td> <td>    6.499</td> <td>    6.644</td>
</tr>
<tr>
  <th>log_age</th>   <td>    0.0807</td> <td>    0.010</td> <td>    7.782</td> <td> 0.000</td> <td>    0.060</td> <td>    0.101</td>
</tr>
<tr>
  <th>online</th>    <td>    0.1447</td> <td>    0.027</td> <td>    5.433</td> <td> 0.000</td> <td>    0.092</td> <td>    0.197</td>
</tr>
<tr>
  <th>products</th>  <td>    0.3456</td> <td>    0.014</td> <td>   24.110</td> <td> 0.000</td> <td>    0.317</td> <td>    0.374</td>
</tr>
</table>
<p>The coefficient for <code>log_age</code> is still positive and statistically significant, but its <strong>magnitude</strong> has halved.</p>
<p>What should we conclude? It seems that <code>sales</code> increase over age, on average. However, this pattern might be very <strong>non-linear</strong>.</p>
<p>Within the linear regression framework, one approach could be to <strong>add extra terms</strong> such as polynomials (<code>age^2</code>) or categorical features (e.g. <code>age &lt; 2</code>). However, it would be really cool if there was a more <strong>flexible</strong> (i.e. <a href="https://en.wikipedia.org/wiki/Nonparametric_statistics" target="_blank" rel="noopener">non-parametric</a>) approach that could inform us on the relationship between firm <code>age</code> and <code>sales</code>.</p>
<p>If only&hellip;</p>
<h2 id="the-binned-scatterplot">The Binned Scatterplot</h2>
<p>The <strong>binned scatterplot</strong> is a very powerful tool that provides a <strong>flexible</strong> and <strong>parsimonious</strong> way of visualizing and summarizing conditional means (and not only) in large datasets.</p>
<p>The <strong>idea</strong> behind the binned scatterplot is to divide the conditioning variable, <code>age</code> in our example, into <strong>equally sized bins or quantiles</strong>, and then plot the conditional mean of the dependent variable, <code>sales</code> in our example, within each bin.</p>
<h3 id="details">Details</h3>
<p><a href="https://arxiv.org/abs/1902.09608" target="_blank" rel="noopener">Cattaneo, Crump, Farrell, Feng (2021)</a> have built an extremely good package for binned scatterplots in R, <a href="https://cran.r-project.org/web/packages/binsreg/index.html" target="_blank" rel="noopener">binsreg</a>. Moreover, they have ported the package to Python. We can install <code>binsreg</code> directly from pip using <code>pip install binsreg</code>. You can find more information on the Python package <a href="https://pypi.org/project/binsreg/" target="_blank" rel="noopener">here</a>, while the original and detailed R package documentation can be found <a href="https://www.rdocumentation.org/packages/binsreg/versions/0.7/topics/binsreg" target="_blank" rel="noopener">here</a>.</p>
<p>The most important choice when building a binned scatterplot is the <strong>number of bins</strong>. The trade-off is the usual <a href="https://en.wikipedia.org/wiki/Bias%E2%80%93variance_tradeoff" target="_blank" rel="noopener"><strong>bias-variance trade-off</strong></a>. By picking a higher number of bins, we have more points in the graph. In the extreme, we end up having a standard <strong>scatterplot</strong> (assuming the conditioning variable is continuous). On the other hand, by decreasing the number bins, the plot will be more stable. However, in the extreme, we will have a <strong>single point</strong> representing the sample mean.</p>
<p><a href="https://arxiv.org/abs/1902.09608" target="_blank" rel="noopener">Cattaneo, Crump, Farrell, Feng (2021)</a> prove that, in the basic binned scatterplot, the number of bins that minimizes the mean squared error is proportional to $n^{1/3}$, where $n$ is the number of observations. Therefore, in general, more observations lead to more bins.</p>
<p><a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/smj.3199" target="_blank" rel="noopener">Starr and Goldfarb (2020)</a> add the following consideration:</p>
<blockquote>
<p>&ldquo;<em>However other elements are also important. For example, holding the distribution of x constant, the more curvilinear the true relationship between x and y is, the more bins the algorithm will select (otherwise mean squared error will increase). This implies that even with large n, few bins will be chosen for relatively flat relationships. The calculation of the optimal number of bins in a basic binned scatterplot thus takes into account the amount and location of variation in the data available to identify the relationship between x and y.</em>&rdquo;</p>
</blockquote>
<p>It is strongly recommended to use the default optimal number of bins. However, one can also set a customized number of bins in <code>binsreg</code> with the <code>nbins</code> option.</p>
<p>Binned scatterplots however, do not just compute conditional means, for optimally chosen intervals, but they can also provide <strong>inference</strong> for these means. In particular, we can build <strong>confidence intervals</strong> around each data point. In the <code>binsreg</code> package, the option <code>ci</code> adds confidence intervals to the estimation results. The option takes as input a tuple of parameters <code>(p, s)</code> and uses a piecewise polynomial of degree <code>p</code> with <code>s</code> smoothness constraints to construct the confidence intervals. By default, the confidence intervals are not included in the plot. For what concerns the choice of <code>p</code> and <code>s</code>, the <a href="https://www.rdocumentation.org/packages/binsreg/versions/0.7/topics/binsreg" target="_blank" rel="noopener">package documentation</a> reports:</p>
<blockquote>
<p>&ldquo;<em>Recommended specification is ci=c(3,3), which adds confidence intervals based on cubic B-spline estimate of the regression function of interest to the binned scatter plot.</em>&rdquo;</p>
</blockquote>
<h3 id="binsreg">Binsreg</h3>
<p>One problem with the Python version of the package, is that is not very Python-ish. Therefore, I have wrapped the <code>binsreg</code> package into a function <code>binscatter</code> that takes care of cleaning and formatting the output in a nicely readable <a href="https://pandas.pydata.org/" target="_blank" rel="noopener">Pandas</a> DataFrame.</p>
<pre><code class="language-python">import binsreg

def binscatter(**kwargs):
    # Estimate binsreg
    est = binsreg.binsreg(**kwargs)
    
    # Retrieve estimates
    df_est = pd.concat([d.dots for d in est.data_plot])
    df_est = df_est.rename(columns={'x': kwargs.get(&quot;x&quot;), 'fit': kwargs.get(&quot;y&quot;)})
    
    # Add confidence intervals
    if &quot;ci&quot; in kwargs:
        df_est = pd.merge(df_est, pd.concat([d.ci for d in est.data_plot]))
        df_est = df_est.drop(columns=['x'])
        df_est['ci'] = df_est['ci_r'] - df_est['ci_l']
    
    # Rename groups
    if &quot;by&quot; in kwargs:
        df_est['group'] = df_est['group'].astype(df[kwargs.get(&quot;by&quot;)].dtype)
        df_est = df_est.rename(columns={'group': kwargs.get(&quot;by&quot;)})

    return df_est
</code></pre>
<p>We can now proceed to <strong>estimate</strong> and <strong>visualize</strong> the binned scatterplot for <code>age</code> based on <code>sales</code>.</p>
<pre><code class="language-python"># Estimate binsreg
df_est = binscatter(x='age', y='sales', data=df, ci=(3,3))
df_est.head()
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>group</th>
      <th>age</th>
      <th>bin</th>
      <th>isknot</th>
      <th>mid</th>
      <th>sales</th>
      <th>ci_l</th>
      <th>ci_r</th>
      <th>ci</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Full Sample</td>
      <td>0.012556</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1624.779616</td>
      <td>1312.439124</td>
      <td>1905.535412</td>
      <td>593.096288</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Full Sample</td>
      <td>0.037015</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1664.078013</td>
      <td>1435.438411</td>
      <td>1893.888819</td>
      <td>458.450408</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Full Sample</td>
      <td>0.065813</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>1779.657894</td>
      <td>1555.909281</td>
      <td>1968.681960</td>
      <td>412.772679</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Full Sample</td>
      <td>0.094486</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>1976.464837</td>
      <td>1740.530049</td>
      <td>2216.800005</td>
      <td>476.269956</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Full Sample</td>
      <td>0.125363</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>2015.833752</td>
      <td>1796.489393</td>
      <td>2280.237320</td>
      <td>483.747927</td>
    </tr>
  </tbody>
</table>
</div>
<p>The <code>binscatter</code> function outputs a dataset in which, for each bin of the conditioning variable, <code>age</code>, we have values and confidence intervals for the outcome variable, <code>sales</code>.</p>
<p>We can now plot the estimates.</p>
<pre><code class="language-python"># Plot binned scatterplot
sns.scatterplot(x='age', y='sales', data=df_est);
plt.errorbar('age', 'sales', yerr='ci', data=df_est, ls='', lw=3, alpha=0.2);
plt.title(&quot;Sales by firm's age&quot;);
</code></pre>
<p><img src="img/binscatter_33_0.png" alt="png"></p>
<p>The plot is quite revealing. Now the relationship looks extremely <strong>non-linear</strong> with a sharp increase in <code>sales</code> at the beginning of the lifetime of a firm, followed by a plateau.</p>
<p>Moreover, the plot is also telling us information regarding the distributions of <code>age</code> and <code>sales</code>. In fact, the plot is more dense on the left, where the distribution of <code>age</code> is concentrated. Also, confidence intervals are tighter on the left, where most of the conditional distribution of <code>sales</code> lies.</p>
<p>As we already discussed in the previous section, it might be important to control for other variables. For example, the number of <code>products</code>, since firms that sell more products probably survive longer in the markets and also make more sales.</p>
<p><code>binsreg</code> allows to <strong>condition</strong> the analysis on any number of variables, with the <code>w</code> option.</p>
<pre><code class="language-python"># Estimate binsreg
df_est = binscatter(x='age', y='sales', w=['products'], data=df, ci=(3,3))

# Plot binned scatterplot
sns.scatterplot(x='age', y='sales', data=df_est);
plt.errorbar('age', 'sales', yerr='ci', data=df_est, ls='', lw=3, alpha=0.2);
plt.title(&quot;Sales by firm's age&quot;);
</code></pre>
<p><img src="img/binscatter_35_0.png" alt="png"></p>
<p>Conditional on number of <code>products</code>, the shape of the <code>sales</code> life-cycle changes further. Now, after an initial increase in sales, we observe a gradual decrease over time.</p>
<p>Do <code>online</code>-only firms have different <code>sales</code> life-cycles with respect to mixed online-offline firms? We can produce different binned scatterplots <strong>by group</strong> using the option <code>by</code>.</p>
<pre><code class="language-python"># Estimate binsreg
df_est = binscatter(x='age', y='sales', by='online', w=['products'], data=df, ci=(3,3))

# Plot binned scatterplot
sns.scatterplot(x='age', y='sales', data=df_est, hue='online');
plt.errorbar('age', 'sales', yerr='ci', data=df_est.query(&quot;online==0&quot;), ls='', lw=3, alpha=0.2);
plt.errorbar('age', 'sales', yerr='ci', data=df_est.query(&quot;online==1&quot;), ls='', lw=3, alpha=0.2);
plt.title(&quot;Sales by firm's age&quot;);
</code></pre>
<p><img src="img/binscatter_37_0.png" alt="png"></p>
<p>From the binned scatterplot, we can see that <code>online</code> products have on average shorter lifetimes, with a higher initial peak in <code>sales</code>, followed by a sharper decline.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this blog post, we have analyzed a very powerful data visualization tool: the <strong>binned scatterplot</strong>. In particular, we have seen how to use the <code>binsreg</code> package to automatically pick the optimal number of bins and perform non-parametric inference on conditional means. However, the <code>binsreg</code> package offers much more than that and I strongly recommend checking <a href="https://cran.r-project.org/web/packages/binsreg/binsreg.pdf" target="_blank" rel="noopener">its manual</a> more in depth.</p>
<h2 id="references">References</h2>
<p>[1] E Starr, B Goldfarb, <a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/smj.3199" target="_blank" rel="noopener">Binned Scatterplots: A Simple Tool to Make Research Easier and Better</a> (2020), Strategic Management Journal.</p>
<p>[2] M. D. Cattaneo, R. K. Crump, M. H. Farrell, Y. Feng, <a href="https://arxiv.org/abs/1902.09608" target="_blank" rel="noopener">On Binscatter</a> (2021), working paper.</p>
<p>[3] P. Goldsmith-Pinkham, <a href="https://www.youtube.com/watch?v=fg9T2gPZCIs" target="_blank" rel="noopener">Lecture 6. Linear Regression II: Semiparametrics and Visualization</a>, Applied Metrics PhD Course.</p>

          </div>
          


















  
  



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="https://matteocourthoud.github.io/"><img class="avatar mr-3 avatar-circle" src="/author/avatar_hu365eedc833ccd5578a90de7c849ec45e_385094_270x270_fill_q75_lanczos_center.jpg" alt=""></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://matteocourthoud.github.io/"></a></h5>
      
      <p class="card-text">I hold a PhD in economics from the University of Zurich. Now I work at the intersection of economics, data science and statistics. I regularly write about causal inference on <a href="https://medium.com/@matteo.courthoud" target="_blank" rel="noopener">Medium</a>.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://medium.com/@matteo.courthoud" target="_blank" rel="noopener">
        <i class="fab fa-medium"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/matteo-courthoud-7335198a/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/MatteoCourthoud/" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/matteocourthoud" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://open.spotify.com/user/1180947523" target="_blank" rel="noopener">
        <i class="fab fa-spotify"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>
















  
  




        </div>
        </article>
    </main>
  </div>
</div>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  

  
  <p class="powered-by">
    
      <a href="/privacy/">Privacy Policy</a>
    
    
       &middot; 
      <a href="/terms/">Terms</a>
    
  </p>
  

  

  
  







</footer>

    </div>
    
  </div>

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js" integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin="anonymous"></script>

      
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.8.4/mermaid.min.js" integrity="sha512-as1BF4+iHZ3BVO6LLDQ7zrbvTXM+c/1iZ1qII/c3c4L8Rn5tHLpFUtpaEtBNS92f+xGsCzsD7b62XP3XYap6oA==" crossorigin="anonymous" title="mermaid"></script>
      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js" integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/python.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/julia.min.js"></script>
        
      

    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js" integrity="sha512-SeiQaaDh73yrb56sTW/RgVdi/mMqNeM2oBwubFHagc5BkixSpP1fvqF47mKzPGWYSSy4RwbBunrJBQ4Co8fRWA==" crossorigin="anonymous"></script>
    

    
    

    
    
    
      
      <script id="search-hit-fuse-template" type="text/x-template">
        <div class="search-hit" id="summary-{{key}}">
          <div class="search-hit-content">
            <div class="search-hit-name">
              <a href="{{relpermalink}}">{{title}}</a>
              <div class="article-metadata search-hit-type">{{type}}</div>
              <p class="search-hit-description">{{snippet}}</p>
            </div>
          </div>
        </div>
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
      
    

    
    

    
    
    
    

    
    <script src="/js/bootstrap.bundle.min.6aed84840afc03ab4d5750157f69c120.js"></script>

    
    
      
      
      
      
      
      
      
    

    
    
    
    
    
    
    
    
      
      
    
    
    <script src="/en/js/wowchemy.min.4ea9cc8d09c5c158656ac1a804743b34.js"></script>

    
  <script async defer src="https://buttons.github.io/buttons.js"></script>




</body>
</html>
